\chapter{Report Workflow}
\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow}{}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow}\index{Report Workflow@{Report Workflow}}
\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md35}%
\Hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md35}%
 \hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md36}{}\doxysection{\texorpdfstring{Description}{Description}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md36}
Generates a csv file which contains all the processed lines of an specific period/month.

The columns considered to build the csv report are the following\+: \tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{2}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }\\\cline{1-2}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ }\\\cline{1-2}
\endhead
quantity   &isrc\+\_\+id    \\\cline{1-2}
release\+\_\+id   &release\+\_\+title    \\\cline{1-2}
track\+\_\+title   &artists    \\\cline{1-2}
label\+\_\+id   &territory\+\_\+code    \\\cline{1-2}
types   &service\+\_\+id    \\\cline{1-2}
date\+\_\+str   &accounting\+\_\+date    \\\cline{1-2}
foreign\+\_\+currency   &total\+\_\+foreign    \\\cline{1-2}
exchange\+\_\+rate   &local\+\_\+currency    \\\cline{1-2}
total\+\_\+local   &\\\cline{1-2}
\end{longtabu}


The general performance is the following\+:


\begin{DoxyEnumerate}
\item Select just the required fields/columns from Mongo\+DB
\item Extract only columns shown previously
\item Generate csv
\item Compress csv to gzip file
\item Sent to user
\end{DoxyEnumerate}

Also this module is able to generate unmatched lines report. This feature is possible only when client has a catalogue with us.\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md37}{}\doxysection{\texorpdfstring{Workflow}{Workflow}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md37}
\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md38}{}\doxysection{\texorpdfstring{How to create venv dev}{How to create venv dev}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md38}

\begin{DoxyEnumerate}
\item Create a new virtual env (if you have created this venv pass to step 4)

{\ttfamily python3 -\/m venv glider\+\_\+dev}
\item Activate venv ~\newline


It\textquotesingle{}s important to keep "{}glider\+\_\+dev"{} name

{\ttfamily source glider\+\_\+dev/bin/activate}
\item Install requirements (only in case that you haven\textquotesingle{}t install requirements yet)

{\ttfamily pip install -\/r src/importer/requirements.\+txt}
\item Activate env variables. You should create two .env files

In this case, the variables for any submodule are the same.

a) .env.\+dev for developing and testing

b) .env.\+prod for production


\begin{DoxyCode}{0}
\DoxyCodeLine{ENVIRONMENT=<Development/Production>}
\DoxyCodeLine{AWS\_KEY\_ID=<YOUR\_AWS\_KEY\_ID>}
\DoxyCodeLine{AWS\_SECRET\_KEY=<YOUR\_AWS\_SECRET\_KEY>}
\DoxyCodeLine{SENDER\_EMAIL="{}example@example.me"{}}
\DoxyCodeLine{SENDER\_PASSWORD=<YOUR\_SENDER\_PASSWORD>}
\DoxyCodeLine{MONGO\_GLIDER=<MONGO\_CONNECTION\_LINK>}
\DoxyCodeLine{DATABASE\_URL=POSTGRES\_DATABASE}
\DoxyCodeLine{DB=<YOUR\_DB>}
\DoxyCodeLine{COLLECTION=<YOUR\_MONGO\_COLLECTION>}
\DoxyCodeLine{SNAPSHOTS\_DB=<YOUR\_MONGO\_DB\_FOR\_SNAPSHOTS>}
\DoxyCodeLine{SNAPSHOTS=<YOUR\_MONGO\_COLLECTION\_FOR\_SNAPSHOTS>}
\DoxyCodeLine{CAT\_COLLECTION=<YOUR\_MONGO\_COLLECTION\_FOR\_CATALOGUE>}
\DoxyCodeLine{REGION=<YOUR\_AWS\_REGION>}
\DoxyCodeLine{AS\_COLLECTION=<YOUR\_MONGO\_COLLECTION\_FOR\_AS\_CATALOGUE>}
\DoxyCodeLine{LAMBDA\_FUNCTION=<LAMBDA\_FUNCTION\_TO\_GENERATE\_PRESIGNED\_LINK>}
\DoxyCodeLine{INSTANCE\_ID\_LITE=<EC2\_TO\_EXECUTE\_LITE\_PROCEDURE>}
\DoxyCodeLine{INSTANCE\_ID\_PRO==<EC2\_TO\_EXECUTE\_PRO\_PROCEDURE>}

\end{DoxyCode}

\item Save and run, remember that you can use either of them

{\ttfamily source deploy/dev\+\_\+vars.\+sh} for developing env

{\ttfamily source deploy/prod\+\_\+vars.\+sh} for production env
\end{DoxyEnumerate}\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md39}{}\doxysection{\texorpdfstring{Testing}{Testing}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md39}
\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md40}{}\doxysubsection{\texorpdfstring{Local Testing}{Local Testing}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md40}

\begin{DoxyEnumerate}
\item Activate venv and variables

{\ttfamily source glider\+\_\+dev/bin/activate}

{\ttfamily source deploy/dev\+\_\+vars.\+sh} ~\newline

\item Make sure you have at less one processed file in Mongo\+DB. If don\textquotesingle{}t, use importer module to process it
\item Into tests/ create a python script following this format\+: test\+\_\+reports.\+py


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ os}
\DoxyCodeLine{import\ sys}
\DoxyCodeLine{import\ traceback}
\DoxyCodeLine{sys.path.insert(1,\ 'src/report\_generation')}
\DoxyCodeLine{sys.path.insert(1,\ 'run')}
\DoxyCodeLine{from\ GenReport\ import\ build\_csv}
\DoxyCodeLine{from\ SendNotification\ import\ send\_report\_notification}
\DoxyCodeLine{}
\DoxyCodeLine{input\_data\ =\ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}module"{}:\ "{}reporting"{},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}tag"{}:\ <<"{}test"{}/"{}prod"{}>>,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}date"{}:\ <<accounting\ date>>,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}client\_id"{}:\ <<client\ id>>,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}bucket"{}:\ <<s3\ bucket\ where\ files\ will\ be\ uploaded>>,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}path"{}:\ <<s3\ path\ where\ files\ will\ be\ uploaded>>,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}report\_type"{}:\ <<"{}monthly"{}/"{}unmatch"{}>>,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}client\_email"{}:\ <<user@email.example>>,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}on\_finish"{}:\ <<webhook.url>>}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{if\ \_\_name\_\_\ ==\ "{}\_\_main\_\_"{}:}
\DoxyCodeLine{\ \ \ \ try:\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ run\_file\_cleaning(input\_data)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ send\_report\_notification("{}success"{},\ input\_data["{}module"{}],\ input\_data["{}on\_finish"{}],\ input\_data["{}client\_email"{}])}
\DoxyCodeLine{\ \ \ \ except\ Exception\ as\ e:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ message\ =\ str(sys.exc\_info()[2])\ +\ str(traceback.format\_exc())}
\DoxyCodeLine{\ \ \ \ \ \ \ \ send\_report\_notification("{}fail"{},\ input\_data["{}module"{}],\ input\_data["{}on\_finish"{}],\ input\_data["{}client\_email"{}],\ message)}

\end{DoxyCode}

\item Run script

{\ttfamily python tests/test\+\_\+reports.\+py}
\end{DoxyEnumerate}\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md41}{}\doxysubsection{\texorpdfstring{AWS Testing}{AWS Testing}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2report__generation_2report__workflow_autotoc_md41}
When infrastructure is deployed in AWS\+:


\begin{DoxyEnumerate}
\item Go to AWS -\/\texorpdfstring{$>$}{>} Step Functions
\item Select the step function (select\+\_\+and\+\_\+execute\+\_\+module)
\item Click on Start execution

(Optional\+: set a testing name)
\item Set json object


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ "{}module"{}:\ "{}reporting"{},}
\DoxyCodeLine{\ \ \ \ "{}tag"{}:\ <<"{}test"{}/"{}prod"{}>>,}
\DoxyCodeLine{\ \ \ \ "{}date"{}:\ <<accounting\ date>>,}
\DoxyCodeLine{\ \ \ \ "{}client\_id"{}:\ <<client\ id>>,}
\DoxyCodeLine{\ \ \ \ "{}bucket"{}:\ <<s3\ bucket\ where\ files\ will\ be\ uploaded>>,}
\DoxyCodeLine{\ \ \ \ "{}path"{}:\ <<s3\ path\ where\ files\ will\ be\ uploaded>>,}
\DoxyCodeLine{\ \ \ \ "{}report\_type"{}:\ <<"{}monthly"{}/"{}unmatch"{}>>,}
\DoxyCodeLine{\ \ \ \ "{}client\_email"{}:\ <<user@email.example>>,}
\DoxyCodeLine{\ \ \ \ "{}on\_finish"{}:\ <<webhook.url>>}
\DoxyCodeLine{\}}

\end{DoxyCode}

\item Click on Start execution. If the execution is successfully, you can see it in EC2 instance


\begin{DoxyCode}{0}
\DoxyCodeLine{ssh\ -\/i\ Glider-\/Postgres.pem\ ubuntu@ec2-\/35-\/179-\/24-\/180.eu-\/west-\/2.compute.amazonaws.com}

\end{DoxyCode}
 
\end{DoxyEnumerate}