\doxysection{Identify\+Format.\+py}
\hypertarget{_identify_format_8py_source}{}\label{_identify_format_8py_source}\index{/Users/michellmonroy/Documents/dev-\/glider/glider/src/importer/IdentifyFormat.py@{/Users/michellmonroy/Documents/dev-\/glider/glider/src/importer/IdentifyFormat.py}}
\mbox{\hyperlink{_identify_format_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00001}\mbox{\hyperlink{namespaceimporter_1_1_identify_format}{00001}}\ \textcolor{comment}{\#\ -\/*-\/\ coding:\ utf-\/8\ -\/*-\/}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00002}00002\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00003}00003\ \textcolor{keyword}{import}\ boto3}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00004}00004\ \textcolor{keyword}{import}\ json}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00005}00005\ \textcolor{keyword}{import}\ chardet\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00006}00006\ \textcolor{comment}{\#\ import\ smart\_open}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00007}00007\ \textcolor{keyword}{import}\ ssl}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00008}00008\ \textcolor{keyword}{from}\ pandas\ \textcolor{keyword}{import}\ read\_excel,\ ExcelFile}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00009}00009\ \textcolor{keyword}{from}\ pymongo\ \textcolor{keyword}{import}\ MongoClient}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00010}00010\ \textcolor{keyword}{from}\ dotenv\ \textcolor{keyword}{import}\ load\_dotenv}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00011}00011\ \textcolor{keyword}{from}\ ReceivePath\ \textcolor{keyword}{import}\ receive\_path}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00012}00012\ \textcolor{keyword}{from}\ ErrorHandler\ \textcolor{keyword}{import}\ *}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00013}00013\ \textcolor{keyword}{from}\ Excel\_to\_csv\ \textcolor{keyword}{import}\ pass\_excel\_to\_csv}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00014}00014\ \textcolor{keyword}{from}\ MongoConnection\ \textcolor{keyword}{import}\ mongo\_connection}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00015}00015\ \textcolor{keyword}{import}\ sys}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00016}00016\ \textcolor{keyword}{import}\ traceback}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00017}00017\ load\_dotenv()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00018}00018\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00019}00019\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00020}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a1483de9d4129b80e27834d5ab4da3a83}{00020}}\ s3\_file\_obj\ =\ \textcolor{keywordtype}{None}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00023}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a1a2827869ca7f6504b7f7e84cd8b1a87}{00023}}\ ENV\ =\ os.environ.get(\textcolor{stringliteral}{"{}ENVIRONMENT"{}})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00024}00024\ print(ENV)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00025}00025\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00027}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_afab6f18bba80cbf85f2f3b4976b913db}{00027}}\ ACCESS\_ID,\ ACCESS\_KEY\ =\ os.environ.get(\textcolor{stringliteral}{"{}AWS\_KEY\_ID"{}}),\ os.environ.get(\textcolor{stringliteral}{"{}AWS\_KEY\_SECRET"{}})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00028}00028\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00030}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a83166f48189474d70e7a4b175fe4f3a0}{00030}}\ mongo\_conn\ =\ \mbox{\hyperlink{classimporter_1_1_mongo_connection_1_1mongo__connection}{mongo\_connection}}()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00031}00031\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00032}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a0207b3aa7ebf0e43d9830a179b917a0d}{00032}}\ collection\ =\ mongo\_conn.mongo\_conn\_formats()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00034}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_abd455f2860dc8e5b571ac1b436dc7171}{00034}}\ snap\_collection\ =\ mongo\_conn.mongo\_conn\_snapshots()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00035}00035\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00036}00036\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00037}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a76469f9a4d8258e4a540abc23edb3a84}{00037}}\ s3\_client\ =\ boto3.client(\textcolor{stringliteral}{"{}s3"{}},\ aws\_access\_key\_id=ACCESS\_ID,\ aws\_secret\_access\_key=\ ACCESS\_KEY)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00038}00038\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00039}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a482e747dcffb74b23e2a24d828658bdc}{00039}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a482e747dcffb74b23e2a24d828658bdc}{download\_obj}}(event,\ file):}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00040}00040\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Receives\ file\ info\ and\ reads\ the\ firsts\ 1024\ bytes\ to\ determinate\ the\ encoding}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00041}00041\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00042}00042\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00043}00043\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ event\ (dict):\ is\ a\ dictionary\ with\ all\ client\ and\ sales\ information}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00044}00044\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ file\ (str):\ current\ filename}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00045}00045\ \textcolor{stringliteral}{\ \ \ \ Returns:\ s3\_file\ (str)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00046}00046\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ \ \ \ \ \ charenc\ (str)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00047}00047\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00048}00048\ \ \ \ \ bucket\ =\ event[\textcolor{stringliteral}{"{}bucket"{}}][0]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00049}00049\ \ \ \ \ path\ =\ event[\textcolor{stringliteral}{"{}path"{}}][0]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00050}00050\ \ \ \ \ obj\ =\ s3\_client.get\_object(Bucket=bucket,\ Key=path+\textcolor{stringliteral}{"{}/"{}}+file,\ Range=\textcolor{stringliteral}{'bytes=0-\/1024'})\ \ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00051}00051\ \ \ \ \ s3\_file\ =\ (obj[\textcolor{stringliteral}{'Body'}].\_raw\_stream).read()\ \ \ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00052}00052\ \ \ \ \ charenc\ =\ chardet.detect(s3\_file).get(\textcolor{stringliteral}{'encoding'})\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00053}00053\ \ \ \ \ \textcolor{comment}{\#\ s3\_dir\ =\ f"{}s3://\{bucket\}/\{path\}/\{file\}"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00054}00054\ \ \ \ \ \textcolor{keywordflow}{if}\ (charenc\ ==\ \textcolor{stringliteral}{"{}ascii"{}})\ \textcolor{keywordflow}{or}\ (charenc\ ==\ \textcolor{stringliteral}{"{}Windows-\/1252"{}}):\textcolor{comment}{\#\ or\ (charenc\ ==\ "{}ISO-\/8859-\/1"{}):}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00055}00055\ \ \ \ \ \ \ \ \ charenc\ =\ \textcolor{stringliteral}{"{}utf-\/8"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00056}00056\ \ \ \ \ \textcolor{keywordflow}{return}\ s3\_file,\ charenc}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00057}00057\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00058}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a31efc6bbc9f3ec7c500a3a756efaad8d}{00058}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a31efc6bbc9f3ec7c500a3a756efaad8d}{csvHeaders}}(event,\ file):}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00059}00059\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Takes\ the\ s3\_file\ content\ and\ decoding\ it\ to\ get\ headers}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00060}00060\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00061}00061\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00062}00062\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ event\ (dict):\ is\ a\ dictionary\ with\ all\ client\ and\ sales\ information}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00063}00063\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ file\ (str):\ current\ filename}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00064}00064\ \textcolor{stringliteral}{\ \ \ \ Returns:\ headers\ (list)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00065}00065\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00066}00066\ \ \ \ \ WINDOWS\_LINE\_ENDING\ =\ \textcolor{stringliteral}{'\(\backslash\)r\(\backslash\)n'}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00067}00067\ \ \ \ \ MAC\_LINE\_ENDING\ =\ \textcolor{stringliteral}{'\(\backslash\)r'}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00068}00068\ \ \ \ \ UNIX\_LINE\_ENDING\ =\ \textcolor{stringliteral}{'\(\backslash\)n'}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00069}00069\ \ \ \ \ \textcolor{keyword}{global}\ encoding\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00070}00070\ \ \ \ \ s3\_file,\ encoding\ =\ \mbox{\hyperlink{namespaceimporter_1_1_identify_format_a482e747dcffb74b23e2a24d828658bdc}{download\_obj}}(event,\ file)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00071}00071\ \ \ \ \ headers\ =\ []}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00072}00072\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00073}00073\ \ \ \ \ \ \ \ \ s3\_file\ =\ s3\_file.decode(encoding)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00074}00074\ \ \ \ \ \ \ \ \ headers\ =\ s3\_file.splitlines()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00075}00075\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ with\ smart\_open.open(s3\_dir,\ encoding=encoding)\ as\ f:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00076}00076\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ \ \ \ \ headers\ =\ [next(f).strip("{}\(\backslash\)n\(\backslash\)r\(\backslash\)r\(\backslash\)n"{})\ for\ x\ in\ range(7)]}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00077}00077\ \ \ \ \ \textcolor{keywordflow}{except}:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}File\ couldn't\ be\ loaded"{}})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ with\ smart\_open.open(s3\_dir,\ encoding=encoding)\ as\ f:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00080}00080\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ \ \ \ \ headers\ =\ [next(f).strip("{}\(\backslash\)n\(\backslash\)r\(\backslash\)r\(\backslash\)n"{})\ for\ x\ in\ range(2)]}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00081}00081\ \ \ \ \ \textcolor{keywordflow}{if}\ len(headers)\ >\ 1:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00082}00082\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ headers}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00083}00083\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00084}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a32be73f5a214d83810e6451914cbdc08}{00084}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a32be73f5a214d83810e6451914cbdc08}{identifyHeaders}}(headers,\ collection):}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00085}00085\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Searches\ format\ using\ headers\ and\ takes\ template\ information.\ Also\ builds\ a\ list\ with\ main\ features\ of\ each\ column}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00086}00086\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00087}00087\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00088}00088\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ headers\ (list):\ contains\ the\ X\ firsts\ lines\ from\ current\ file}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00089}00089\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ collection\ (mongo\ collection):\ Mongo\ collection\ where\ formats\ templates\ are\ storage}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00090}00090\ \textcolor{stringliteral}{\ \ \ \ Returns:\ template\_format\ (dict)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00091}00091\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00092}00092\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00093}00093\ \ \ \ \ skip\_rows\ =\ 0}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00094}00094\ \ \ \ \ \textcolor{comment}{\#\ print(headers)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00095}00095\ \ \ \ \ \textcolor{keywordflow}{for}\ header\ \textcolor{keywordflow}{in}\ headers:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00096}00096\ \ \ \ \ \ \ \ \ template\_format\ =\ collection.find\_one(\{\textcolor{stringliteral}{"{}header"{}}:\ header\})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00097}00097\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ template\_format:\textcolor{comment}{\#\ and\ template\_format[0]:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00098}00098\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}FORMAT:\ \{\}\ \(\backslash\)t\ VERSION:\ \{\}\ \(\backslash\)t\ DELIMITER:\ \{\}"{}}.format(template\_format[\textcolor{stringliteral}{"{}format"{}}],\ template\_format[\textcolor{stringliteral}{"{}version"{}}],\ template\_format[\textcolor{stringliteral}{"{}delimiters"{}}]))}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00099}00099\ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}HEADER\ IDENTIFIED:\ \{\}"{}}.format(header))}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00100}00100\ \ \ \ \ \ \ \ \ \ \ \ \ ottoMapping\_columns\ =\ \mbox{\hyperlink{namespaceimporter_1_1_identify_format_a3371091bd79a1894f162950d7b3326aa}{cols\_otto}}(json.loads(template\_format[\textcolor{stringliteral}{"{}schema"{}}]),\ json.loads(template\_format[\textcolor{stringliteral}{"{}ottoMapping"{}}]))}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00101}00101\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ template\_format[\textcolor{stringliteral}{"{}format"{}}],\ template\_format[\textcolor{stringliteral}{"{}delimiters"{}}],\ ottoMapping\_columns,\ skip\_rows}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00102}00102\ \ \ \ \ \ \ \ \ skip\_rows+=1}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00103}00103\ \ \ \ \ \textcolor{keywordflow}{raise}\ Exception(\textcolor{stringliteral}{"{}No\ format\ identified"{}})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00104}00104\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00105}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a15570bb0e03a40059c773832ed82f530}{00105}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a15570bb0e03a40059c773832ed82f530}{type\_schema}}(schema):}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00106}00106\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Takes\ the\ schema\ field\ from\ database\ and\ gets\ the\ main\ features\ of\ each\ column}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00107}00107\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00108}00108\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00109}00109\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ schema\ (list):\ contains\ the\ columns\ features\ from\ current\ file}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00110}00110\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ collection\ (mongo\ collection):\ Mongo\ collection\ where\ formats\ templates\ are\ storage}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00111}00111\ \textcolor{stringliteral}{\ \ \ \ Returns:\ template\_format\ (dict)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00112}00112\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00113}00113\ \ \ \ \ schema\ =\ schema[\textcolor{stringliteral}{"{}parameters"{}}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00114}00114\ \ \ \ \ values\ =\ dict()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00115}00115\ \ \ \ \ flagsNull\ =\ dict()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00116}00116\ \ \ \ \ mapper\ =\ \{\textcolor{stringliteral}{"{}StringType"{}}:\ \textcolor{stringliteral}{"{}object"{}},\ \textcolor{stringliteral}{"{}IntegerType"{}}:\ \textcolor{stringliteral}{"{}int64"{}},\ \textcolor{stringliteral}{"{}DoubleType"{}}:\ \textcolor{stringliteral}{"{}float64"{}},\ \textcolor{stringliteral}{"{}DateType"{}}:\ \textcolor{stringliteral}{"{}datetime64[us]"{}}\}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00117}00117\ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ schema:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00118}00118\ \ \ \ \ \ \ \ \ values[i[\textcolor{stringliteral}{"{}structFieldTemplate"{}}][\textcolor{stringliteral}{"{}name"{}}]]\ =\ mapper[i[\textcolor{stringliteral}{"{}structFieldTemplate"{}}][\textcolor{stringliteral}{"{}ftype"{}}]]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00119}00119\ \ \ \ \ \ \ \ \ flagsNull[i[\textcolor{stringliteral}{"{}structFieldTemplate"{}}][\textcolor{stringliteral}{"{}name"{}}]]\ =\ i[\textcolor{stringliteral}{"{}structFieldTemplate"{}}][\textcolor{stringliteral}{"{}flagNull"{}}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00120}00120\ \ \ \ \ \textcolor{keywordflow}{return}\ values,\ flagsNull}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00121}00121\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00122}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a3371091bd79a1894f162950d7b3326aa}{00122}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_identify_format_a3371091bd79a1894f162950d7b3326aa}{cols\_otto}}(schema,\ ottoMapping):}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00123}00123\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Builds\ the\ relation\ between\ main\ features\ of\ each\ column\ in\ the\ file\ and\ the\ mapping\ template}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00124}00124\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00125}00125\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00126}00126\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ schema\ (list):\ contains\ the\ columns\ features\ from\ current\ file}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00127}00127\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ ottoMapping\ (list):\ contains\ the\ columns\ features\ from\ the\ desired\ template\ }}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00128}00128\ \textcolor{stringliteral}{\ \ \ \ Returns:\ match\ (list)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00129}00129\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00130}00130\ \ \ \ \ otto\_keys\ =\ ottoMapping[\textcolor{stringliteral}{'parameters'}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00131}00131\ \ \ \ \ dtypes,\ flags\ =\ \mbox{\hyperlink{namespaceimporter_1_1_identify_format_a15570bb0e03a40059c773832ed82f530}{type\_schema}}(schema)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00132}00132\ \ \ \ \ match\ =\ []}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00133}00133\ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ otto\_keys:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00134}00134\ \ \ \ \ \ \ \ \ ottoMapping\_row\ =\ i[\textcolor{stringliteral}{'mappingTemplate'}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00135}00135\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ print(ottoMapping\_row)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00136}00136\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ ottoMapping\_row[\textcolor{stringliteral}{"{}ftype"{}}]\ ==\ \textcolor{stringliteral}{"{}header"{}}:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ ottoMapping\_row[\textcolor{stringliteral}{"{}value"{}}]\ =\ ottoMapping\_row[\textcolor{stringliteral}{"{}value"{}}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00138}00138\ \ \ \ \ \ \ \ \ \ \ \ \ ottoMapping\_row[\textcolor{stringliteral}{"{}dtype"{}}]\ =\ dtypes[ottoMapping\_row[\textcolor{stringliteral}{"{}value"{}}]]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ ottoMapping\_row[\textcolor{stringliteral}{"{}flagNull"{}}]\ =\ flags[ottoMapping\_row[\textcolor{stringliteral}{"{}value"{}}]]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00140}00140\ \ \ \ \ \ \ \ \ match.append(ottoMapping\_row)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00141}00141\ \ \ \ \ \textcolor{keywordflow}{return}\ match}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00142}00142\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00143}\mbox{\hyperlink{namespaceimporter_1_1_identify_format_abbce3715159bdeb7ab493532484a02a0}{00143}}\ \textcolor{keyword}{def\ }identify\_format(event,\ context=None):}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00144}00144\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Executes\ full\ procedure\ filter\ csv,\ txt\ and\ xls\ files}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00145}00145\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00146}00146\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00147}00147\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ event\ (dict):\ is\ a\ dictionary\ with\ all\ client\ and\ sales\ information}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00148}00148\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ context\ (none):\ it's\ required\ just\ for\ lambda\ execution}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00149}00149\ \textcolor{stringliteral}{\ \ \ \ Returns:\ (dict)}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00150}00150\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00151}00151\ \ \ \ \ \textcolor{keyword}{global}\ encoding}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00152}00152\ \ \ \ \ event\ =\ receive\_path(event,\ s3\_client)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00153}00153\ \ \ \ \ print(\textcolor{stringliteral}{"{}Status="{}},event[\textcolor{stringliteral}{"{}status"{}}])}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00154}00154\ \ \ \ \ status\ =\ \textcolor{stringliteral}{"{}OK"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00155}00155\ \ \ \ \ not\_identified\ =\ dict()\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00156}00156\ \ \ \ \ csv\_formats\ =\ dict()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00157}00157\ \ \ \ \ \textcolor{keywordflow}{for}\ files\ \textcolor{keywordflow}{in}\ event[\textcolor{stringliteral}{"{}files"{}}]:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ file\ =\ files[\textcolor{stringliteral}{"{}file"{}}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00159}00159\ \ \ \ \ \ \ \ \ file\_db\_id\ =\ files[\textcolor{stringliteral}{"{}file\_id"{}}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00160}00160\ \ \ \ \ \ \ \ \ print(file)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ file\_extension\ =\ os.path.splitext(file)[1]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00162}00162\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{stringliteral}{"{}xls"{}}\ \textcolor{keywordflow}{in}\ file\_extension:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ s3\_file\_obj\ =\ s3\_client.get\_object(Bucket=event[\textcolor{stringliteral}{"{}bucket"{}}][0],\ Key=event[\textcolor{stringliteral}{"{}path"{}}][0]+\textcolor{stringliteral}{'/'}+file)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00165}00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ xls\ =\ ExcelFile(s3\_file\_obj[\textcolor{stringliteral}{'Body'}].read())}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00166}00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ pass\_excel\_to\_csv(event,\ files,\ xls,\ s3\_client)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00167}00167\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00168}00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(e)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00169}00169\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\ =\ \textcolor{stringliteral}{"{}\{\}\(\backslash\)n\{\}"{}}.format(sys.exc\_info()[2],\ traceback.format\_exc())}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ not\_identified[file\_db\_id]\ =\ \{\textcolor{stringliteral}{"{}file"{}}:\ file\}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00171}00171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ eh\ \ =\ \mbox{\hyperlink{classimporter_1_1_error_handler_1_1_error_handler}{ErrorHandler}}()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00172}00172\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ error\ =\ eh.handle(e,\ m,\ file\_db\_id)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00173}00173\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ status\ =\ error}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00174}00174\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}Maybe\ there\ is\ a\ sheet\ not\ identified"{}})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00175}00175\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00176}00176\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00177}00177\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00178}00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00179}00179\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ csv\_headers\ =\ \mbox{\hyperlink{namespaceimporter_1_1_identify_format_a31efc6bbc9f3ec7c500a3a756efaad8d}{csvHeaders}}(event,\ file)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00180}00180\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ formats,\ delimiter,\ otto\_cols,\ skip\_rows\ =\ \mbox{\hyperlink{namespaceimporter_1_1_identify_format_a32be73f5a214d83810e6451914cbdc08}{identifyHeaders}}(csv\_headers,\ collection)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00181}00181\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ formats\ \textcolor{keywordflow}{not}\ \textcolor{keywordflow}{in}\ csv\_formats:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00182}00182\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ csv\_formats[formats]\ =\ \{\textcolor{stringliteral}{"{}files"{}}:[\{\textcolor{stringliteral}{"{}file\_id"{}}:file\_db\_id,\ \textcolor{stringliteral}{"{}file"{}}:\ file,\ \textcolor{stringliteral}{"{}delimiter"{}}:\ delimiter,\ \textcolor{stringliteral}{"{}skip\_rows"{}}:\ skip\_rows,\ \textcolor{stringliteral}{"{}encoding"{}}:encoding\}],\ \textcolor{stringliteral}{"{}columns"{}}:\ otto\_cols\}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00183}00183\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00184}00184\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ csv\_list\ =\ csv\_formats[formats][\textcolor{stringliteral}{"{}files"{}}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00185}00185\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ csv\_list.append(\{\textcolor{stringliteral}{"{}file\_id"{}}:file\_db\_id,\ \textcolor{stringliteral}{"{}file"{}}:\ file,\ \textcolor{stringliteral}{"{}delimiter"{}}:\ delimiter,\ \textcolor{stringliteral}{"{}skip\_rows"{}}:\ skip\_rows,\ \textcolor{stringliteral}{"{}encoding"{}}:encoding\})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00186}00186\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00187}00187\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(e)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00188}00188\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\ =\ \textcolor{stringliteral}{"{}\{\}\(\backslash\)n\{\}"{}}.format(sys.exc\_info()[2],\ traceback.format\_exc())}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00189}00189\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ print(sys.exc\_info()[2])}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00190}00190\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ print(traceback.format\_exc())}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00191}00191\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ eh\ \ =\ \mbox{\hyperlink{classimporter_1_1_error_handler_1_1_error_handler}{ErrorHandler}}()}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00192}00192\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ error\ =\ eh.handle(e,\ m,\ file\_db\_id)}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00193}00193\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ not\_identified[file\_db\_id]\ =\ \{\textcolor{stringliteral}{"{}file"{}}:file,\ \textcolor{stringliteral}{"{}error"{}}:error\}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00194}00194\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ status\ =\ \textcolor{stringliteral}{"{}OK"{}}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00195}00195\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}File\ \{\}\ not\ identified"{}}.format(file))}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00196}00196\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00197}00197\ \ \ \ \ \ \ \ \ snap\_collection.update\_one(\{\textcolor{stringliteral}{"{}file\_db\_id"{}}:file\_db\_id\},\{\textcolor{stringliteral}{"{}\$set"{}}:\{\textcolor{stringliteral}{"{}status"{}}:\textcolor{stringliteral}{"{}identified"{}}\}\})}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00198}00198\ }
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00199}00199\ \ \ \ \ \textcolor{keywordflow}{return}\ \{}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00200}00200\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}OK"{}},}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00201}00201\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}tag"{}}:\ event[\textcolor{stringliteral}{"{}tag"{}}],}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00202}00202\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}cat\_gen"{}}:\ event[\textcolor{stringliteral}{"{}cat\_gen"{}}],}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00203}00203\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}bucket"{}}:\ event[\textcolor{stringliteral}{"{}bucket"{}}],}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00204}00204\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}path"{}}:\ event[\textcolor{stringliteral}{"{}path"{}}],}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00205}00205\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}client\_id"{}}:\ event[\textcolor{stringliteral}{"{}client\_id"{}}],}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00206}00206\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}format"{}}:\ csv\_formats,}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00207}00207\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}no\_format\_identified"{}}:\ not\_identified,}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00208}00208\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}currency"{}}:\ event[\textcolor{stringliteral}{"{}currency"{}}]}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00209}00209\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_identify_format_8py_source_l00210}00210\ }

\end{DoxyCode}
