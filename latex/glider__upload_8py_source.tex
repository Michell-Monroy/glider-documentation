\doxysection{glider\+\_\+upload.\+py}
\hypertarget{glider__upload_8py_source}{}\label{glider__upload_8py_source}\index{/Users/michellmonroy/Documents/dev-\/glider/glider/src/importer/glider\_upload.py@{/Users/michellmonroy/Documents/dev-\/glider/glider/src/importer/glider\_upload.py}}
\mbox{\hyperlink{glider__upload_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00001}\mbox{\hyperlink{namespaceimporter_1_1glider__upload}{00001}}\ \textcolor{keyword}{import}\ sys}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00002}00002\ \textcolor{keyword}{import}\ pymongo}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00003}00003\ \textcolor{keyword}{import}\ boto3}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00004}00004\ \textcolor{keyword}{from}\ dotenv\ \textcolor{keyword}{import}\ load\_dotenv}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00005}00005\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00006}00006\ \textcolor{keyword}{import}\ logging}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00007}00007\ \textcolor{keyword}{import}\ json}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00008}00008\ \textcolor{keyword}{import}\ time}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00009}00009\ }
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00010}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_abab82529b8e81f25fb85a5c6e975a151}{00010}}\ path\ =\ os.path.dirname(sys.argv[0])}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00011}00011\ load\_dotenv(\textcolor{stringliteral}{'\{\}/.env'}.format(path))\ \textcolor{comment}{\#full\_path}}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00012}00012\ }
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00013}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_ac1dcd2e242cdbe963f74ed219eb6a5f9}{00013}}\ file\ =\ sys.argv[1]}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00014}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_ac0896547f38563a4d4204665e66bfa47}{00014}}\ file\_id\ =\ sys.argv[2]}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00015}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a4758d2f4418c625046518d01e6e39ea6}{00015}}\ client\_id\ =\ sys.argv[3]}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00016}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a6bcb36fe27fbcbd56dc3bbe1569bddb0}{00016}}\ exchange\_rates\ =\ sys.argv[4]}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00017}00017\ print(file)}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00018}00018\ \textcolor{comment}{\#\ filename\ =\ sys.argv[5]}}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00019}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_ae8fdd2ec8e5d1ff52f30b9a6e5753761}{00019}}\ myclient\ =\ pymongo.MongoClient(os.environ.get(\textcolor{stringliteral}{'MONGO\_CONNECTION'}))}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00020}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_aac6cc11604f3a3c8533e64078d3c24cd}{00020}}\ mydb\ =\ myclient[\textcolor{stringliteral}{"{}myFirstDatabase"{}}]}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00021}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_ace1c0af4e9767d8df74cecfc4c7f4304}{00021}}\ mycol\ =\ mydb[\textcolor{stringliteral}{"{}files"{}}]}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00023}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a33be05f0f32d3c4937a977ede8012bf1}{00023}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a33be05f0f32d3c4937a977ede8012bf1}{addToMongo}}(s3\_path,\ file\_id,\ client\_id,\ filepath):}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00024}00024\ \ \ \ \ file\_dict\ =\ \{\ \textcolor{stringliteral}{"{}file\_db\_id"{}}:\ file\_id,\ \textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}pending"{}},\ \textcolor{stringliteral}{"{}client\_id"{}}:\ \ client\_id,\ \textcolor{stringliteral}{'name'}:\ os.path.basename(filepath),\ \textcolor{stringliteral}{"{}s3\_path"{}}:s3\_path\}}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00025}00025\ \ \ \ \ logging.info(\textcolor{stringliteral}{'inserting\_file'})}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00026}00026\ \ \ \ \ result\ =\ mycol.replace\_one(\{\textcolor{stringliteral}{"{}file\_db\_id"{}}:\ file\_id\},\ file\_dict,\ upsert=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00028}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a4132e751bbe980882edea7d8dd5f0168}{00028}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a4132e751bbe980882edea7d8dd5f0168}{upload\_to\_s3}}(file,\ client\_id):}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00029}00029\ \ \ \ \ s3\_client\ =\ boto3.client(\textcolor{stringliteral}{'s3'})}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00030}00030\ \ \ \ \ object\_name\ =\ \textcolor{stringliteral}{'\{\}/\{\}'}.format(client\_id,os.path.basename(file))}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00031}00031\ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00032}00032\ \ \ \ \ \ \ \ \ response\ =\ s3\_client.upload\_file(file,\ os.environ.get(\textcolor{stringliteral}{'BUCKET\_INPUT'}),\ object\_name)}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00033}00033\ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00034}00034\ \ \ \ \ \ \ \ \ logging.error(e)}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00035}00035\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{False}}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00036}00036\ \ \ \ \ \textcolor{keywordflow}{return}\ object\_name}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00037}00037\ }
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00038}\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a317cb4aa5b383112a3b413ca2cbd9bc9}{00038}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1glider__upload_a317cb4aa5b383112a3b413ca2cbd9bc9}{trigger\_step\_function\_ingest}}(file\_id,\ client\_id,\ file):}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00039}00039\ \ \ \ \ step\_functions\_client\ =\ boto3.client(\textcolor{stringliteral}{"{}stepfunctions"{}})}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00040}00040\ \ \ \ \ input\_parameters\ =\ \{}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00041}00041\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}client\_id"{}}:\ client\_id,}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}bucket"{}}:[os.environ.get(\textcolor{stringliteral}{'BUCKET\_INPUT'}),\ os.environ.get(\textcolor{stringliteral}{'BUCKET\_OUTPUT'})],}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}path"{}}:[\textcolor{stringliteral}{"{}\{\}"{}}.format(client\_id),\ \textcolor{stringliteral}{"{}\{\}"{}}.format(client\_id)],}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}currency"{}}:\ \{\textcolor{stringliteral}{"{}EUR"{}}:\ 1,\ \textcolor{stringliteral}{"{}USD"{}}:\ 1,\ \textcolor{stringliteral}{"{}GBP"{}}:\ 1\},}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00045}00045\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}files"{}}:\ [\{\textcolor{stringliteral}{"{}file\_id"{}}:\ file\_id,\ \textcolor{stringliteral}{"{}file"{}}:\ file\}]}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00046}00046\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00047}00047\ }
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00048}00048\ \ \ \ \ execution\_name\ =\ \textcolor{stringliteral}{'\{\}-\/\{\}-\/\{\}-\/\{\}'}.format(file\_id,client\_id,\textcolor{stringliteral}{'ottito'},\ int(time.time()))}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00049}00049\ \ \ \ \ response\ =\ step\_functions\_client.start\_execution(}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00050}00050\ \ \ \ \ \ \ \ \ stateMachineArn=os.environ.get(\textcolor{stringliteral}{'INGESTION\_STEP\_FUNCTION\_ARN'}),}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00051}00051\ \ \ \ \ \ \ \ \ name=execution\_name,}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00052}00052\ \ \ \ \ \ \ \ \ input=json.dumps(input\_parameters),}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00053}00053\ \ \ \ \ )}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00054}00054\ \ \ \ \ result\ =\ mycol.update\_one(\{\textcolor{stringliteral}{"{}file\_db\_id"{}}:\ file\_id\},\{\textcolor{stringliteral}{"{}\$set"{}}:\ \{\textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}processing"{}}\}\})}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00055}00055\ }
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00056}00056\ \textcolor{comment}{\#\ s3\_path\ =\ upload\_to\_s3(file,\ client\_id)}}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00057}00057\ \textcolor{comment}{\#\ addToMongo(s3\_path,\ file\_id,\ client\_id,\ file)}}
\DoxyCodeLine{\Hypertarget{glider__upload_8py_source_l00058}00058\ \textcolor{comment}{\#\ trigger\_step\_function\_ingest(file\_id,\ client\_id,\ os.path.basename(file))}}

\end{DoxyCode}
