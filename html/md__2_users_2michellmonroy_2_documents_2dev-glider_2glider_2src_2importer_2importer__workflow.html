<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Glider: importer_workflow</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Glider
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">importer_workflow</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><img src="https://hashicorp.github.io/field-workshops-terraform/slides/aws/terraform-cloud/images/tf_aws.png" alt="" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md8"></a>
Prerrequisites</h1>
<ul>
<li>Python &gt;= 3.8</li>
<li>AWS Account</li>
<li>Terraform <a href="https://www.terraform.io/downloads">install</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md9"></a>
How to set env variables and venv</h1>
<p>There are two kind of variables, to dev and local testing.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
How to create venv dev</h2>
<ol type="1">
<li>Create a new virtual env (if you have created this venv pass to step 4)</li>
</ol>
<p><code>python3 -m venv glider_dev</code></p>
<p>It's important conservate "glider_dev" name</p>
<ol type="1">
<li>Activate venv</li>
</ol>
<p><code>source glider_dev/bin/activate</code></p>
<ol type="1">
<li>Install requirements</li>
</ol>
<p><code>pip install -r src/importer/requirements.txt</code></p>
<ol type="1">
<li>Activate env variables. You should create two .env files a) .env.dev for developing and testing b) .env.prod for production Both files have the same format, just add your dev and prod credentials for each file. Here's an example <div class="fragment"><div class="line">AWS_KEY_ID=&lt;YOUR_AWS_KEY_ID&gt;</div>
<div class="line">AWS_SECRET_KEY=&lt;YOUR_AWS_SECRET_KEY&gt;</div>
<div class="line">SENDER_EMAIL=&quot;example@example.me&quot;</div>
<div class="line">SENDER_PASSWORD=&lt;YOUR_SENDER_PASSWORD&gt;</div>
<div class="line">MONGO_GLIDER=&lt;MONGO_CONNECTION_LINK&gt;</div>
<div class="line">DB=&lt;YOUR_DB&gt;</div>
<div class="line">COLLECTION=&lt;YOUR_MONGO_COLLECTION&gt;</div>
<div class="line">SNAPSHOTS_DB=&lt;YOUR_MONGO_DB_FOR_SNAPSHOTS&gt;</div>
<div class="line">FORMATS=&lt;YOUR_MONGO_COLLECTION_FOR_FROMATS&gt;</div>
<div class="line">SNAPSHOTS=&lt;YOUR_MONGO_COLLECTION_FOR_SNAPSHOTS&gt;</div>
<div class="line">CAT_COLLECTION=&lt;YOUR_MONGO_COLLECTION_FOR_CATALOGUE&gt;</div>
<div class="line">REGION=&lt;YOUR_AWS_REGION&gt;</div>
<div class="line">AS_COLLECTION=&lt;YOUR_MONGO_COLLECTION_FOR_AS_CATALOGUE&gt;</div>
</div><!-- fragment --></li>
<li>Save and run</li>
</ol>
<p><code>source deploy/dev_vars.sh</code> for developing env <code>source deploy/prod_vars.sh</code> for production env</p>
<p>It loads env vars to be used still you change them.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
How to create venv local testing</h2>
<ol type="1">
<li>Create a new virtual env (if you have created this venv pass to step 4)</li>
</ol>
<p><code>python3 -m venv glider_testing</code></p>
<ol type="1">
<li>Activate venv</li>
</ol>
<p><code>source glider_testing/bin/activate</code></p>
<ol type="1">
<li>Install requirements</li>
</ol>
<p><code>pip install -r src/importer/requirements.txt</code></p>
<ol type="1">
<li>Run</li>
</ol>
<p><code>source deploy/dev_vars.sh</code></p>
<p>This command activate glider_testing env and loads the env variables in glider/.env file which is useful to deploy infrastructure</p>
<h1><a class="anchor" id="autotoc_md12"></a>
How to deploy terraform code</h1>
<ol type="1">
<li>Load .env file with dev variables</li>
</ol>
<p><code>source deploy/dev_vars.sh</code> for developing env <code>source deploy/prod_vars.sh</code> for production env</p>
<ol type="1">
<li>Open a terminal and put it on Glider/infrastructure folder.</li>
</ol>
<p><code>cd infrastructure/</code></p>
<ol type="1">
<li>In Glider/infrastructure there are main.tf and variables.tf files. This is AWS infrastructure and env variables.</li>
</ol>
<p>The env variables format is the following configure it with your AWS ACCESS KEY ID and AWS SECRET ACCESS KEY (You can copy these values from .env file)</p>
<div class="fragment"><div class="line">variable &quot;zones&quot; {</div>
<div class="line"> </div>
<div class="line">type = string</div>
<div class="line"> </div>
<div class="line">default = &lt;&lt;aws_zone&gt;&gt;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">variable &quot;access_key&quot;{</div>
<div class="line"> </div>
<div class="line">type = string</div>
<div class="line"> </div>
<div class="line">default = &lt;&lt;your_aws_access_key_id&gt;&gt;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">variable &quot;secret_key&quot;{</div>
<div class="line"> </div>
<div class="line">type = string</div>
<div class="line"> </div>
<div class="line">default = &lt;&lt;your_aws_secret_access_key&gt;&gt;</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li>Start terraform env using <code>terraform init</code>.</li>
<li>Create a new env to testing or dev: <code>terraform workspace new &lt;&lt;env_name&gt;&gt;</code> this command helps us to have a version control.</li>
<li>Verify that you are in the correct env using <code>terraform workspace list</code> it should show the current workspace.</li>
<li>To check if the code in main.tf is right, use <code>terraform plan</code>.</li>
<li>If everytinh is ok, apply infrstructure using <code>terraform apply</code> and wait for it.</li>
<li>Go to <a href="https://aws.amazon.com/">AWS</a> and confirm that all configuration is created (lambda and step functions).</li>
</ol>
<p><b>WARNING</b>: To destroy infrastructure, use <code>terraform destroy</code>. This destroy all infrastructure indicated in main.tf</p>
<p><b>More info</b></p>
<ul>
<li><a href="https://learn.hashicorp.com/collections/terraform/aws-get-started">Terraform commands</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md13"></a>
Testing</h1>
<h2><a class="anchor" id="autotoc_md14"></a>
Local Testing</h2>
<ol type="1">
<li>Upload one or more valid file in AWS s3 bucket</li>
<li>Activate testing variables</li>
</ol>
<p><code>source deploy/dev_vars.sh</code></p>
<ol type="1">
<li>Into tests/ create a python script following this format: test_script.py</li>
</ol>
<div class="fragment"><div class="line">import sys</div>
<div class="line">sys.path.insert(1, &quot;src/importer&quot;)</div>
<div class="line">from ReceivePath import receive_path</div>
<div class="line">from IdentifyFormat import identify_format</div>
<div class="line">from ProcessFiles import process_files_parallel</div>
<div class="line">from CreateSnapshots import results_grouped</div>
<div class="line">from generator import lambda_handler</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">test_data = {</div>
<div class="line">&quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">&quot;cat_gen&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, #True for generate catalogue from sales, False for don&#39;t</div>
<div class="line">&quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">&quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">&quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line"> </div>
<div class="line">&quot;currency&quot;: { #Currency can change</div>
<div class="line">&quot;USD&quot;: 1,</div>
<div class="line">&quot;EUR&quot;: 1,</div>
<div class="line">&quot;GBP&quot;: 1</div>
<div class="line">},</div>
<div class="line"> </div>
<div class="line">&quot;files&quot;:[</div>
<div class="line">{&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">{&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">]</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">  </div>
<div class="line"> </div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    try:</div>
<div class="line">        identify_formats = identify_format(input_data)</div>
<div class="line">        print(&quot;Formats identified: &quot;,identify_formats)</div>
<div class="line">        files_processed = process_files_parallel(identify_formats)</div>
<div class="line">        print(&quot;Files Processed: &quot;,files_processed)</div>
<div class="line">        snapshots = results_grouped(files_processed, None)</div>
<div class="line">        print(&quot;Snapshots: &quot;,snapshots)</div>
<div class="line">        if files_processed[&quot;cat_gen&quot;] == &quot;True&quot;:</div>
<div class="line">            catalogue = generate_catalogue(snapshots, None)</div>
<div class="line">            print(&quot;Catalogue: &quot;, catalogue)</div>
<div class="line">    except Exception as e:</div>
<div class="line">        print(sys.exc_info()[2])</div>
<div class="line">        print(traceback.format_exc())</div>
</div><!-- fragment --><ol type="1">
<li>Run script</li>
</ol>
<p><code>python tests/test_script.py</code></p>
<h2><a class="anchor" id="autotoc_md15"></a>
AWS Testing</h2>
<p>When infrastructure is deployed in AWS:</p>
<ol type="1">
<li>Go to AWS -&gt; Step Functions</li>
<li>Select the step function (importer)</li>
<li>Click on Start execution</li>
</ol>
<p>(Optional: set a testing name)</p>
<ol type="1">
<li>Set json object</li>
</ol>
<div class="fragment"><div class="line">{</div>
<div class="line">&quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">&quot;cat_gen&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, #True for generate catalogue from sales, False for don&#39;t</div>
<div class="line">&quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">&quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">&quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line"> </div>
<div class="line">&quot;currency&quot;: { #Currency can change</div>
<div class="line">&quot;USD&quot;: 1,</div>
<div class="line">&quot;EUR&quot;: 1,</div>
<div class="line">&quot;GBP&quot;: 1</div>
<div class="line">},</div>
<div class="line"> </div>
<div class="line">&quot;files&quot;:[</div>
<div class="line">{&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">{&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">]</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><ol type="1">
<li>Click on Start execution. If the execution is successfully, you can see it in EC2 instance <div class="fragment"><div class="line">ssh -i Glider-Postgres.pem ubuntu@ec2-18-133-236-61.eu-west-2.compute.amazonaws.com</div>
</div><!-- fragment --> See <a href="https://docs.google.com/document/d/1yEcPxPBK8RBpN2z5zJ147FhQOccZWD3ZeglD2RstY-A/edit?usp=sharing">OTTO Documentation</a> for more information about EC2 </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
