<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<<<<<<< HEAD
<meta name="generator" content="Doxygen 1.10.0"/>
=======
<meta name="generator" content="Doxygen 1.12.0"/>
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Glider: Importer Workflow</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<<<<<<< HEAD
=======
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Glider
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<<<<<<< HEAD
<!-- Generated by Doxygen 1.10.0 -->
=======
<!-- Generated by Doxygen 1.12.0 -->
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<<<<<<< HEAD
=======
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
<<<<<<< HEAD
  initMenu('',true,false,'search.php','Search');
=======
  initMenu('',true,false,'search.php','Search',false);
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<<<<<<< HEAD
=======
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<<<<<<< HEAD
=======
<div id="doc-content">
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
<div><div class="header">
  <div class="headertitle"><div class="title">Importer Workflow</div></div>
</div><!--header-->
<div class="contents">
<<<<<<< HEAD
<div class="textblock"><p><a class="anchor" id="autotoc_md31"></a> </p>
<h1><a class="anchor" id="autotoc_md32"></a>
Description</h1>
<p>Importer module is composed of these steps:</p>
<ol type="1">
<li>Receive usage reports: This step takes two paths from s3 (input path and output path) and takes the files to process. This function must check if the input path is a valid path to continue the process</li>
<li>Identify formats: Once the file is validated, there is a function which is in charge of searching for its format in a collection called “formats” in MongoDB. The search is carried out as follows:</li>
<li>Gets the header from each usage report</li>
<li>Searches into MongoDB some format whose “header” field is the same as the usage report header.</li>
<li>When the format is identified, the format name is extracted.</li>
<li>Map columns: Once the format of each usage report is already known, it’s possible to extract the columns, and data type necessary to carry out the mapping. <br  />
 This process is carried out by format and not by file, that is, the format already specifies which columns to use, so these are extracted from the “ottoMapping” field of the json files.</li>
<li>Generate new data using mapped columns: Once the required columns and their respective values are known, DataFrames are created (one per file) in which the columns are constructed according to the "name" field of "mappingTemplate" field from format.json. <br  />
 When this step is completed, the new usage reports are saved in s3 as parquet and mongoDB.</li>
</ol>
<h1><a class="anchor" id="autotoc_md33"></a>
Workflow</h1>
<p><img src="https://github.com/Michell-Monroy/glider-documentation/blob/images-dev/images/Importer_Workflow.png?raw=true" alt="" style="width:700px;height:900px;" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md34"></a>
How to set env variables and venv</h1>
<p>There are two kind of variables, to dev and local testing.</p>
<h2><a class="anchor" id="autotoc_md35"></a>
How to create venv dev</h2>
<ol type="1">
<li><p class="startli">Create a new virtual env (if you have created this venv pass to step 4)</p>
<p class="startli"><code>python3 -m venv glider_dev</code></p>
<p class="startli">It's important to keep "glider_dev" name</p>
</li>
<li><p class="startli">Activate venv</p>
<p class="startli"><code>source glider_dev/bin/activate</code></p>
</li>
<li><p class="startli">Install requirements</p>
<p class="startli"><code>pip install -r src/importer/requirements.txt</code></p>
</li>
<li><p class="startli">Activate env variables. You should create two .env files</p>
<p class="startli">a) .env.dev for developing and testing</p>
<p class="startli">b) .env.prod for production</p>
<p class="startli">Both files have the same format, just add your dev and prod credentials for each file. Here's an example </p><div class="fragment"><div class="line">ENVIRONMENT=&lt;Development/Production&gt;</div>
<div class="line">AWS_KEY_ID=&lt;YOUR_AWS_KEY_ID&gt;</div>
<div class="line">AWS_SECRET_KEY=&lt;YOUR_AWS_SECRET_KEY&gt;</div>
<div class="line">SENDER_EMAIL=&quot;example@example.me&quot;</div>
<div class="line">SENDER_PASSWORD=&lt;YOUR_SENDER_PASSWORD&gt;</div>
<div class="line">MONGO_GLIDER=&lt;MONGO_CONNECTION_LINK&gt;</div>
<div class="line">DATABASE_URL=POSTGRES_DATABASE</div>
<div class="line">DB=&lt;YOUR_DB&gt;</div>
<div class="line">COLLECTION=&lt;YOUR_MONGO_COLLECTION&gt;</div>
<div class="line">TRENDS_COLLECTION=&lt;YOUR_MONGO_COLLECTION_FOR_TRENDS&gt;</div>
<div class="line">SNAPSHOTS_DB=&lt;YOUR_MONGO_DB_FOR_SNAPSHOTS&gt;</div>
<div class="line">FORMATS=&lt;YOUR_MONGO_COLLECTION_FOR_FORMATS&gt;</div>
<div class="line">SNAPSHOTS=&lt;YOUR_MONGO_COLLECTION_FOR_SNAPSHOTS&gt;</div>
<div class="line">CAT_COLLECTION=&lt;YOUR_MONGO_COLLECTION_FOR_CATALOGUE&gt;</div>
<div class="line">REGION=&lt;YOUR_AWS_REGION&gt;</div>
<div class="line">AS_COLLECTION=&lt;YOUR_MONGO_COLLECTION_FOR_AS_CATALOGUE&gt;</div>
<div class="line">LAMBDA_FUNCTION=&lt;LAMBDA_FUNCTION_TO_GENERATE_PRESIGNED_LINK&gt;</div>
<div class="line">FTP_ACCESS=&lt;YOUR_MONGO_COLLECTION_FOR_FTP_CREDENTIALS&gt;</div>
<div class="line">INSTANCE_ID_LITE=&lt;EC2_TO_EXECUTE_LITE_PROCEDURE&gt;</div>
<div class="line">INSTANCE_ID_PRO=&lt;EC2_TO_EXECUTE_PRO_PROCEDURE&gt;</div>
</div><!-- fragment --></li>
<li><p class="startli">Save and run</p>
<p class="startli"><code>source deploy/dev_vars.sh</code> for developing env <code>source deploy/prod_vars.sh</code> for production env</p>
<p class="startli">It loads env vars to be used still you change them.</p>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md36"></a>
How to create venv local testing</h2>
<ol type="1">
<li><p class="startli">Create a new virtual env (if you have created this venv pass to step 4)</p>
<p class="startli"><code>python3 -m venv glider_testing</code></p>
</li>
<li><p class="startli">Activate venv</p>
<p class="startli"><code>source glider_testing/bin/activate</code></p>
</li>
<li><p class="startli">Install requirements</p>
<p class="startli"><code>pip install -r src/importer/requirements.txt</code></p>
</li>
<li><p class="startli">Run</p>
<p class="startli"><code>source deploy/dev_vars.sh</code></p>
<p class="startli">This command activate glider_testing env and loads the env variables in glider/.env file which is useful to deploy infrastructure</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md37"></a>
Testing</h1>
<h2><a class="anchor" id="autotoc_md38"></a>
Local Testing</h2>
<ol type="1">
<li>Upload one or more valid file in AWS s3 bucket</li>
<li><p class="startli">Activate testing variables</p>
<p class="startli"><code>source deploy/dev_vars.sh</code></p>
</li>
<li><p class="startli">Into tests/ create a python script following this format: test_importer.py</p>
<div class="fragment"><div class="line">import os</div>
<div class="line">import sys</div>
<div class="line">import traceback</div>
<div class="line">sys.path.insert(1, &quot;src/importer&quot;)</div>
<div class="line">sys.path.insert(1, &quot;run&quot;)</div>
<div class="line">from ReceivePath import receive_path</div>
<div class="line">from IdentifyFormat import identify_format</div>
<div class="line">from ProcessFiles import process_files_parallel</div>
<div class="line">from CreateSnapshots import results_grouped</div>
<div class="line">from CatalogueGenerator import generate_catalogue</div>
<div class="line">from SendNotifications import send_importer_notification</div>
<div class="line">from RunEC2 import stop_ec2</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">test_data = {</div>
<div class="line">    &quot;module&quot;: &quot;importer&quot;,</div>
<div class="line">    &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">    &quot;cat_gen&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, #True for generate catalogue from sales, False for don&#39;t</div>
<div class="line">    &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">    &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">    &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">    </div>
<div class="line">    &quot;currency&quot;: { #Currency can change</div>
<div class="line">        &quot;USD&quot;: 1,</div>
<div class="line">        &quot;EUR&quot;: 1,</div>
<div class="line">        &quot;GBP&quot;: 1</div>
<div class="line">    },</div>
<div class="line">    </div>
<div class="line">    &quot;files&quot;:[</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">    ],</div>
<div class="line">    &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    try: </div>
<div class="line">        identify_formats = identify_format(input_data)</div>
<div class="line">        print(&quot;Formats identified: &quot;,identify_formats)</div>
<div class="line">        files_processed = process_files_parallel(identify_formats)</div>
<div class="line">        print(&quot;Files Processed: &quot;,files_processed)</div>
<div class="line">        snapshots = results_grouped(files_processed, None)</div>
<div class="line">        print(&quot;Snapshots: &quot;,snapshots)</div>
<div class="line">        if files_processed[&quot;cat_gen&quot;] == &quot;True&quot;:</div>
<div class="line">            catalogue = generate_catalogue(snapshots, None)</div>
<div class="line">            print(&quot;Catalogue: &quot;, catalogue)</div>
<div class="line">        send_importer_notification(&quot;success&quot;, input_data[&quot;module&quot;], input_data[&quot;on_finish&quot;])</div>
<div class="line">        stop_ec2()</div>
<div class="line">    except Exception as e:</div>
<div class="line">        message = str(sys.exc_info()[2]) + str(traceback.format_exc())</div>
<div class="line">        send_importer_notification(&quot;fail&quot;, input_data[&quot;module&quot;], input_data[&quot;on_finish&quot;], message)</div>
</div><!-- fragment --></li>
<li><p class="startli">Run script</p>
<p class="startli"><code>python tests/test_importer.py</code></p>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md39"></a>
AWS Testing</h2>
<p>When infrastructure is deployed in AWS:</p>
<ol type="1">
<li>Go to AWS -&gt; Step Functions</li>
<li>Select the step function (select_and_execute_module)</li>
<li><p class="startli">Click on Start execution</p>
<p class="startli">(Optional: set a testing name)</p>
</li>
<li><p class="startli">Set json object</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;module&quot;: &quot;importer&quot;,</div>
<div class="line">    &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">    &quot;cat_gen&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, </div>
<div class="line">    &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">    &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">    &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">    </div>
<div class="line">    &quot;currency&quot;: { </div>
<div class="line">        &quot;USD&quot;: 1,</div>
<div class="line">        &quot;EUR&quot;: 1,</div>
<div class="line">        &quot;GBP&quot;: 1</div>
<div class="line">    },</div>
<div class="line">    </div>
<div class="line">    &quot;files&quot;:[</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">    ],</div>
<div class="line">    &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><p class="startli">Click on Start execution. If the execution is successfully, you can see it in EC2 instance</p>
<p class="startli">a) In glider-lite </p><div class="fragment"><div class="line">ssh -i Glider-Postgres.pem ubuntu@ec2-35-179-24-180.eu-west-2.compute.amazonaws.com</div>
</div><!-- fragment --><p> b) In glider-pro </p><div class="fragment"><div class="line">ssh -i Glider-Postgres.pem ubuntu@ec2-18-168-188-120.eu-west-2.compute.amazonaws.com</div>
</div><!-- fragment --> </li>
</ol>
=======
<div class="textblock"><p><a class="anchor" id="autotoc_md9"></a></p>
<h1><a class="anchor" id="autotoc_md10"></a>
Description</h1>
<p>The main task of the importer is to homogenize the input data, transforming it into a format that can be used by the system.</p>
<p>To achieve this, the importer module is composed of these steps:</p>
<ol type="1">
<li>Receive usage reports: This step takes two paths from s3 (input path and output path) and takes the files to process. This function must check if the input path is a valid path to continue the process</li>
<li>Identify formats: Once the file is validated, there is a function which is in charge of searching for its format in a collection called "formats" in MongoDB. The search is carried out as follows:</li>
<li>Gets the header from each usage report</li>
<li>Searches into MongoDB some format whose "header" field is the same as the usage report header.</li>
<li>When the format is identified, the format name is extracted.</li>
<li>Map columns: Once the format of each usage report is already known, it’s possible to extract the columns, and data type necessary to carry out the mapping. <br  />
 This process is carried out by format and not by file, that is, the format already specifies which columns to use, so these are extracted from the "ottoMapping" field of the json files.</li>
<li>Generate new data using mapped columns: Once the required columns and their respective values are known, DataFrames are created (one per file) in which the columns are constructed according to the "name" field of "mappingTemplate" field from format.json. <br  />
 When this step is completed, the new usage reports are saved in s3 as parquet and mongoDB.</li>
</ol>
<h1><a class="anchor" id="autotoc_md11"></a>
Workflow</h1>
<p><img src="Importer_Workflow.png" alt="" class="inline"/>    </p>
<h1><a class="anchor" id="autotoc_md12"></a>
Input format</h1>
<p>The input for this module consists in a json object which detemines what is the file(s) to process and currencies to apply.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Field   </th><th class="markdownTableHeadNone">Description   </th><th class="markdownTableHeadNone">Example    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>module</b>   </td><td class="markdownTableBodyNone">This field determines which route will be called. In this case it must to be "importer".   </td><td class="markdownTableBodyNone">"importer"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>tag</b>   </td><td class="markdownTableBodyNone">This field determines which env variables have to be loaded.   </td><td class="markdownTableBodyNone">"test", "testing", "prod"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>cat_gen</b>   </td><td class="markdownTableBodyNone">Sometimes, the current sales are used to autogenerate a new catalogue. If cat_gen = "False" the catalogue is not generated, else cat_gen = "True" the current sales are used to generate or update the catalogue.   </td><td class="markdownTableBodyNone">"True", "False"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>cat_match</b>   </td><td class="markdownTableBodyNone">Some files require a cat sanitization, so it means there is an existing catalog. In this case cat_match = "False", but there are other files which have no catalog, so it is necessary to generate it using the current sales. In this case cat_match = "True".   </td><td class="markdownTableBodyNone">"True", "False"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>client_id</b>   </td><td class="markdownTableBodyNone">String which represents the id of each client.   </td><td class="markdownTableBodyNone">"client1"    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>bucket</b>   </td><td class="markdownTableBodyNone">List of strings which contains 2 elements: input bucket (where files have been uploaded) and output bucket (where results will be uploaded). These items must exist in your AWS account.   </td><td class="markdownTableBodyNone">["bucket-input", "bucket-output"]    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>path</b>   </td><td class="markdownTableBodyNone">List of strings which contains 2 elements: input path (where files have been uploaded) and output path (where results will be uploaded). These items must exist in your AWS account.   </td><td class="markdownTableBodyNone">["path-input", "path-output"]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>base_currency</b>   </td><td class="markdownTableBodyNone">String which represents the base currency defined by the client. It should be in ISO-4217 format.   </td><td class="markdownTableBodyNone">"MXN"    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>currency</b>   </td><td class="markdownTableBodyNone">List of dictionaries which contains exchange rates and currencies (it depends on each client), also it includes the period of time for which the exchange rates are valid.   </td><td class="markdownTableBodyNone">[ { "currency": "USD", "period": "2024/06/29", "value": 34 }, { "currency": "EUR", "period": "2024/06/29", "value": 26 } ]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>currency_exception</b> (Optional)   </td><td class="markdownTableBodyNone">List of dictionaries which contains exchange rates, their respective currencies and the DSP which exchange rates will be applied (it depends on each client), also it includes the period of time for which the exchange rates are valid.   </td><td class="markdownTableBodyNone">[ { "dsp": "Youtube", "period": "2030-04-03", "currencies": [ { "currency": "USD", "value": 1.30 }, { "currency": "EUR", "value": 1.15 }, { "currency": "GBP", "value": 1.40 } ] }, { "dsp": "Itunes", "period": "2030-04-03", "currencies": [ { "currency": "USD", "value": 1.34 }, { "currency": "EUR", "value": 1.26 }, { "currency": "GBP", "value": 1.38 } ] } ]    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>files</b>   </td><td class="markdownTableBodyNone">List of dictionaries. Each dictionary contains file_id and file fields. <br  />
 <b>file_id</b>: String which represents the id of each file. It must not be repeated. <br  />
 <b>file</b>: String which represents the filename of each file. Sometimes, the filename is used for some formats to identify data keys, e.g., some formats which may not have a date in the data will have it in the filename and the importer will attempt to take the date from the filename.   </td><td class="markdownTableBodyNone">[{"file_id": "file1", "file": "filename1.csv"}, {"file_id": "file2", "file": "filename2"}]    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>on_finish</b>   </td><td class="markdownTableBodyNone">Webhook link to send final status.   </td><td class="markdownTableBodyNone"><a href="https://your_webhook.site/">https://your_webhook.site/</a>   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md13"></a>
Allowed extensions</h1>
<ul>
<li>CSV format <a href="https://www.reviversoft.com/en/file-extensions/csv">More info</a> <br  />
</li>
<li>TXT format: <a href="https://www.reviversoft.com/en/file-extensions/txt">More info</a></li>
<li>TSV format: <a href="https://www.reviversoft.com/en/file-extensions/tsv">More info</a></li>
<li>XLS format: <a href="https://www.reviversoft.com/en/file-extensions/xls">More info</a> <br  />
</li>
</ul>
<h1><a class="anchor" id="autotoc_md14"></a>
Local Example</h1>
<h2><a class="anchor" id="autotoc_md15"></a>
Example using python</h2>
<ol type="1">
<li>Upload one or more valid file in AWS s3 bucket. It could be manually or via upload module</li>
<li>Set testing variables</li>
<li><p class="startli">Run server locally a) If you are using flask, run</p>
<p class="startli"><code>python app.py</code></p>
<p class="startli">b) If you use Docker, run</p>
<p class="startli"><code>docker-compose -f local.yml up</code></p>
<p class="startli">It runs a local sever in 5000 port. If you go to <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> in your browser you would see the api interface</p>
</li>
<li><p class="startli">Into tests/ create a python script following this format: test_route_importer.py</p>
<div class="fragment"><div class="line">import os</div>
<div class="line">import sys</div>
<div class="line">import traceback</div>
<div class="line">import requests</div>
<div class="line"> </div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    input_data = {</div>
<div class="line">        &quot;module&quot;: &quot;importer&quot;,</div>
<div class="line">        &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">        &quot;cat_gen&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, </div>
<div class="line">        &quot;cat_match&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, </div>
<div class="line">        &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">        &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">        &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">        &quot;base_currency&quot;: &lt;&lt;currency in ISO-4217 format&gt;&gt;,</div>
<div class="line">        &quot;currency&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;currency&quot;: &quot;USD&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2024/06/29&quot;,</div>
<div class="line">                &quot;value&quot;: 34</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;currency&quot;: &quot;EUR&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2024/06/29&quot;,</div>
<div class="line">                &quot;value&quot;: 26</div>
<div class="line">            }</div>
<div class="line">        ],</div>
<div class="line">        &quot;currency_exception&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;dsp&quot;: &quot;Youtube&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2030-04-03&quot;,</div>
<div class="line">                &quot;currencies&quot;: [</div>
<div class="line">                    {&quot;currency&quot;: &quot;USD&quot;, &quot;value&quot;: 1.30},</div>
<div class="line">                    {&quot;currency&quot;: &quot;EUR&quot;, &quot;value&quot;: 1.15},</div>
<div class="line">                    {&quot;currency&quot;: &quot;GBP&quot;, &quot;value&quot;: 1.40},</div>
<div class="line">                ]</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;dsp&quot;: &quot;Itunes&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2030-04-03&quot;,</div>
<div class="line">                &quot;currencies&quot;: [</div>
<div class="line">                    {&quot;currency&quot;: &quot;USD&quot;, &quot;value&quot;: 1.34},</div>
<div class="line">                    {&quot;currency&quot;: &quot;EUR&quot;, &quot;value&quot;: 1.26},</div>
<div class="line">                    {&quot;currency&quot;: &quot;GBP&quot;, &quot;value&quot;: 1.38},</div>
<div class="line">                ]</div>
<div class="line">            }</div>
<div class="line">        ],</div>
<div class="line">        &quot;files&quot;:[</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">        ],</div>
<div class="line">        &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">    response = requests.post(&#39;http://127.0.0.1:5000/importer&#39;, json=input_data)</div>
<div class="line">    print(response.json())</div>
</div><!-- fragment --></li>
<li><p class="startli">Run script</p>
<p class="startli"><code>python tests/test_route_importer.py</code></p>
<p class="startli">If everything is ok, it returns the following:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;message&#39;: &#39;Module procedure will start immediately&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;importer&#39;, </div>
<div class="line">    &#39;status&#39;: 200</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli">If a field is missing or it's wrong, it returns:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;error_in_field&#39;: [&#39;client_id&#39;], </div>
<div class="line">    &#39;error_message&#39;: &#39;Field required&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;importer&#39;, </div>
<div class="line">    &#39;status&#39;: 500</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md16"></a>
Example using CURL</h2>
<ol type="1">
<li>Upload one or more valid file in AWS s3 bucket. It could be manually or via upload module</li>
<li>Open a terminal</li>
<li>Set the input <div class="fragment"><div class="line">curl -X &#39;POST&#39; \</div>
<div class="line">&#39;http://127.0.0.1:5000/importer&#39; \</div>
<div class="line">-H &#39;accept: application/json&#39; \</div>
<div class="line">-H &#39;Content-Type: application/json&#39; \</div>
<div class="line">-d &#39;{</div>
<div class="line">    &quot;module&quot;: &quot;importer&quot;,</div>
<div class="line">        &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">        &quot;cat_gen&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, </div>
<div class="line">        &quot;cat_match&quot;: &lt;&quot;True&quot;/&quot;False&quot;&gt;, </div>
<div class="line">        &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">        &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">        &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">        &quot;base_currency&quot;: &lt;&lt;currency in ISO-4217 format&gt;&gt;,</div>
<div class="line">        &quot;currency&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;currency&quot;: &quot;USD&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2024/06/29&quot;,</div>
<div class="line">                &quot;value&quot;: 34</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;currency&quot;: &quot;EUR&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2024/06/29&quot;,</div>
<div class="line">                &quot;value&quot;: 26</div>
<div class="line">            }</div>
<div class="line">        ],</div>
<div class="line">        &quot;currency_exception&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;dsp&quot;: &quot;Youtube&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2030-04-03&quot;,</div>
<div class="line">                &quot;currencies&quot;: [</div>
<div class="line">                    {&quot;currency&quot;: &quot;USD&quot;, &quot;value&quot;: 1.30},</div>
<div class="line">                    {&quot;currency&quot;: &quot;EUR&quot;, &quot;value&quot;: 1.15},</div>
<div class="line">                    {&quot;currency&quot;: &quot;GBP&quot;, &quot;value&quot;: 1.40},</div>
<div class="line">                ]</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;dsp&quot;: &quot;Itunes&quot;,</div>
<div class="line">                &quot;period&quot;: &quot;2030-04-03&quot;,</div>
<div class="line">                &quot;currencies&quot;: [</div>
<div class="line">                    {&quot;currency&quot;: &quot;USD&quot;, &quot;value&quot;: 1.34},</div>
<div class="line">                    {&quot;currency&quot;: &quot;EUR&quot;, &quot;value&quot;: 1.26},</div>
<div class="line">                    {&quot;currency&quot;: &quot;GBP&quot;, &quot;value&quot;: 1.38},</div>
<div class="line">                ]</div>
<div class="line">            }</div>
<div class="line">        ],</div>
<div class="line">        </div>
<div class="line">        &quot;files&quot;:[</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">        ],</div>
<div class="line">        &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line">}&#39;</div>
</div><!-- fragment --></li>
<li><p class="startli">Put the input in your terminal and Enter</p>
<p class="startli">If everything is ok, it returns the following:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;message&#39;: &#39;Module procedure will start immediately&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;importer&#39;, </div>
<div class="line">    &#39;status&#39;: 200</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli">If a field is missing or it's wrong, it returns:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;error_in_field&#39;: [&#39;client_id&#39;], </div>
<div class="line">    &#39;error_message&#39;: &#39;Field required&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;importer&#39;, </div>
<div class="line">    &#39;status&#39;: 500</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md17"></a>
Example using API in Browser</h2>
<ul>
<li><p class="startli">Run server locally</p>
<p class="startli">a) If you are using flask, run</p>
<p class="startli"><code>python app.py</code></p>
<p class="startli">b) If you use Docker, run</p>
<p class="startli"><code>docker-compose -f local.yml up</code></p>
</li>
<li>Go to <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a></li>
<li>Click on "Default" text and "importer" button</li>
</ul>
<p><img src="api-web.png" alt="" style="width:800px;height:700px;" class="inline"/></p>
<ul>
<li>Click on "Try it out" button</li>
</ul>
<p><img src="api-box-importer.png" alt="" style="width:900px;height:400px;" class="inline"/></p>
<ul>
<li>Add the input in the text box and click on "Execute" button</li>
</ul>
<h2><a class="anchor" id="autotoc_md18"></a>
AWS Routes</h2>
<p>When infrastructure is deployed in AWS (ECS, ECR):</p>
<p>Repeat all steps shown in previously, just change the link to server</p>
<p>a) For glider-staging </p><div class="fragment"><div class="line">http://glider-spot-staging-lb-999571427.us-east-1.elb.amazonaws.com/importer</div>
</div><!-- fragment --><p> b) For glider-production (unavailable) </p><div class="fragment"><div class="line">http://glider-production-lb-120036359.us-east-1.elb.amazonaws.com/importer</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md19"></a>
Troubleshooting</h1>
<h2><a class="anchor" id="autotoc_md20"></a>
Files not identified</h2>
<ol type="1">
<li><p class="startli">Go to webhook and check the status of procedure</p>
<p class="startli">If <code>status</code> is "fail" and <code>notification</code> includes "No format identified", means that the file header doesn’t match with any format in the database. So you have to add it.</p>
</li>
<li>Contact support to add a new format</li>
</ol>
<h2><a class="anchor" id="autotoc_md21"></a>
Files not processed</h2>
<p>Go to webhook and check the status of procedure and check the <code>notification</code> field</p>
<h3><a class="anchor" id="autotoc_md22"></a>
Currency not found error</h3>
<p>If the error look like this you have to add the missing currency</p>
<p><b>Option 1</b>: Add the missing currency in <code>currency</code> field in the input</p>
<p><b>Option 2</b>: If option 1 didn't work contact support to fix problem</p>
<h3><a class="anchor" id="autotoc_md23"></a>
File could not be loaded</h3>
<p>This issue can be happened due an encoding error or a format change or code bug</p>
<p><b>Possible solution</b>: Contac to support</p>
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
<<<<<<< HEAD
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
=======
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
>>>>>>> 4d6acd55a96da5cbf13e5842eae0fed6acfe4019
</body>
</html>
