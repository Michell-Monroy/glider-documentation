\doxysection{Report\+Snapshot.\+py}
\hypertarget{_report_snapshot_8py_source}{}\label{_report_snapshot_8py_source}\index{/Users/michellmonroy/Documents/dev-\/glider/glider/src/report\_generation/ReportSnapshot.py@{/Users/michellmonroy/Documents/dev-\/glider/glider/src/report\_generation/ReportSnapshot.py}}
\mbox{\hyperlink{_report_snapshot_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00001}\mbox{\hyperlink{namespace_report_snapshot}{00001}}\ \textcolor{keyword}{import}\ ssl}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00002}00002\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00003}00003\ \textcolor{keyword}{import}\ awswrangler\ \textcolor{keyword}{as}\ wr}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00004}00004\ \textcolor{keyword}{import}\ boto3}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00005}00005\ \textcolor{keyword}{import}\ sys,\ traceback}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00006}00006\ \textcolor{keyword}{from}\ pandas\ \textcolor{keyword}{import}\ DataFrame,\ concat}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00007}00007\ \textcolor{keyword}{from}\ datetime\ \textcolor{keyword}{import}\ datetime\ \textcolor{keyword}{as}\ dt}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00008}00008\ \textcolor{keyword}{from}\ pymongo\ \textcolor{keyword}{import}\ MongoClient}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00009}00009\ \textcolor{keyword}{from}\ dotenv\ \textcolor{keyword}{import}\ load\_dotenv}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00010}00010\ \textcolor{keyword}{from}\ botocore.exceptions\ \textcolor{keyword}{import}\ ClientError}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00011}\mbox{\hyperlink{namespace_report_snapshot_a3d2d63b5a76762a3a9d446f2020ebfe4}{00011}}\ f\_path\ =\ \_\_file\_\_}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00012}\mbox{\hyperlink{namespace_report_snapshot_a493ebf6121b88a8b629ddb60e498f503}{00012}}\ index\ =\ f\_path.find(\textcolor{stringliteral}{"{}report\_generation/"{}})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00013}00013\ f\_path\ =\ f\_path[:index]}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00014}00014\ sys.path.insert(1,\ f\_path+\textcolor{stringliteral}{'importer'})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00015}00015\ \textcolor{keyword}{from}\ MongoConnection\ \textcolor{keyword}{import}\ mongo\_connection}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00016}00016\ load\_dotenv()}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00018}00018\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00019}\mbox{\hyperlink{namespace_report_snapshot_a59583ca70cb2351f5ddbd468db13ee24}{00019}}\ ACCESS\_ID,\ ACCESS\_KEY\ =\ os.environ.get(\textcolor{stringliteral}{"{}AWS\_KEY\_ID"{}}),\ os.environ.get(\textcolor{stringliteral}{"{}AWS\_KEY\_SECRET"{}})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00020}00020\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00022}\mbox{\hyperlink{namespace_report_snapshot_a656392c6261d12e0cdfeb2dac6d382e0}{00022}}\ mongo\_conn\ =\ mongo\_connection()}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00023}00023\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00024}\mbox{\hyperlink{namespace_report_snapshot_a934e21a368825fb600d7d4ffe7631953}{00024}}\ snap\_collection\ =\ mongo\_conn.mongo\_conn\_snapshots()}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00025}00025\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00026}\mbox{\hyperlink{namespace_report_snapshot_a9708b903819d920a4553e277f2f2290b}{00026}}\ final\_df\ =\ DataFrame()}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00027}\mbox{\hyperlink{namespace_report_snapshot_a60747d9e82279ba6a019e6e737f66ca0}{00027}}\ total\_rows\ =\ 0}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00028}\mbox{\hyperlink{namespace_report_snapshot_a5076344f8f3c921e9d877dad90a54a84}{00028}}\ total\_local\ =\ 0}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00030}00030\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00031}\mbox{\hyperlink{namespace_report_snapshot_a24e32d77f91c807604150367b99c10a7}{00031}}\ session\ =\ boto3.Session(aws\_access\_key\_id=ACCESS\_ID,\ aws\_secret\_access\_key=\ ACCESS\_KEY)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00033}\mbox{\hyperlink{namespace_report_snapshot_ad1d92ff734086f7f9a1d42f5ae674f59}{00033}}\ update\_at\ =\ \ dt.now().replace(hour=0,\ minute=0,\ second=0,\ microsecond=0)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00034}00034\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00035}\mbox{\hyperlink{namespace_report_snapshot_a4038a78dd7952cb6dfbbdfa6beb24fca}{00035}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespace_report_snapshot_a4038a78dd7952cb6dfbbdfa6beb24fca}{read\_report\_csv}}(filename,\ chunk):}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00036}00036\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Receives\ a\ S3\ path\ and\ loads\ the\ data\ using\ awswrangler\ ans\ chunks\ (1M\ lines\ per\ chunk)}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00037}00037\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00038}00038\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00039}00039\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ filename\ (str):\ s3\ file\ location}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00040}00040\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ chunk\ (int):\ chunk\ size}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00041}00041\ \textcolor{stringliteral}{\ \ \ \ Returns:\ final\_df\ (pandas\ dataframe)}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00042}00042\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00043}00043\ \ \ \ \ \textcolor{keyword}{global}\ final\_df,\ total\_rows,\ total\_local}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00044}00044\ \ \ \ \ \_dfs\ =\ wr.s3.read\_csv(filename,\ low\_memory=\textcolor{keyword}{False},\ chunksize=chunk,\ keep\_default\_na=\textcolor{keyword}{False},\ boto3\_session=session)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00045}00045\ \ \ \ \ \textcolor{keywordflow}{for}\ df\ \textcolor{keywordflow}{in}\ \_dfs:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00046}00046\ \ \ \ \ \ \ \ \ total\_rows\ +=\ df.shape[0]}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ total\_local\ +=\ float(df[\textcolor{stringliteral}{"{}total\_local"{}}].sum())}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ df.sort\_values(\textcolor{stringliteral}{"{}total\_local"{}},\ ascending=\textcolor{keyword}{False},\ inplace=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00049}00049\ \ \ \ \ \ \ \ \ df\ =\ df.iloc[:10000,:]}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00050}00050\ \ \ \ \ \ \ \ \ final\_df\ =\ concat([final\_df,\ df],\ ignore\_index=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00051}00051\ \ \ \ \ \textcolor{keywordflow}{return}\ final\_df}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00052}00052\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00053}\mbox{\hyperlink{namespace_report_snapshot_a0a15f5df30b9169ee9e6c75baf35dc38}{00053}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespace_report_snapshot_a0a15f5df30b9169ee9e6c75baf35dc38}{group\_by\_field}}(data,\ fields,\ snapshot):}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00054}00054\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Group\ by\ service\_id,\ territory\_code,\ artists\ and\ tracks}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00055}00055\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00056}00056\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00057}00057\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ data\ (pandas\ dataframe):\ current\ parquet\ file\ loaded\ as\ dataframe}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00058}00058\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ fields\ (list):\ list\ of\ fields\ that\ are\ considered\ to\ snapshot}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00059}00059\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ snapshot\ (dict):\ it\ will\ contain\ all\ fields\ info}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00060}00060\ \textcolor{stringliteral}{\ \ \ \ Returns:\ snap\ (dict)}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00061}00061\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00062}00062\ \ \ \ \ \textcolor{comment}{\#Group\ by\ service\_id,\ territory\_code.\ artists}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00063}00063\ \ \ \ \ \textcolor{keywordflow}{for}\ field\ \textcolor{keywordflow}{in}\ fields:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00064}00064\ \ \ \ \ \ \ \ \ df\_grouped\ =\ data.groupby(field)[\textcolor{stringliteral}{"{}total\_local"{}}].sum()}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00065}00065\ \ \ \ \ \ \ \ \ snap\ =\ \mbox{\hyperlink{namespace_report_snapshot_a98e6f1f0b14bea0bdb8bd9c1b11a187d}{build\_snapshot}}(df\_grouped,\ field,\ snapshot)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00066}00066\ \ \ \ \ \textcolor{keywordflow}{return}\ snap}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00067}00067\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00068}\mbox{\hyperlink{namespace_report_snapshot_a98e6f1f0b14bea0bdb8bd9c1b11a187d}{00068}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespace_report_snapshot_a98e6f1f0b14bea0bdb8bd9c1b11a187d}{build\_snapshot}}(df,\ field,\ snapshot):}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00069}00069\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Checks\ the\ field\ and\ fill\ the\ snapshot\ field\ using\ grouped\ data.}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00070}00070\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00071}00071\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00072}00072\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ df\ (pandas\ dataframe):\ current\ parquet\ file\ loaded\ as\ dataframe}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00073}00073\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ field\ (str):\ current\ file\ used\ as\ filter}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00074}00074\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ snapshot\ (dict):\ it\ will\ contain\ all\ fields\ info}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00075}00075\ \textcolor{stringliteral}{\ \ \ \ Returns:\ snapshot\ (dict)}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00076}00076\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00077}00077\ \ \ \ \ df.sort\_values(ascending=\textcolor{keyword}{False},\ inplace=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00078}00078\ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ df.index[:50]:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ field\ ==\ \textcolor{stringliteral}{"{}release\_id"{}}:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00080}00080\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}release\_id"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00081}00081\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byUPC"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00082}00082\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ field\ ==\ \textcolor{stringliteral}{"{}artists"{}}:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00083}00083\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}artist"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00084}00084\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byArtist"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00085}00085\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ field\ ==\ \textcolor{stringliteral}{"{}service\_id"{}}:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00086}00086\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}service"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00087}00087\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byDSP"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00088}00088\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ field\ ==\ \textcolor{stringliteral}{"{}territory\_code"{}}:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00089}00089\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}territory\_code"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00090}00090\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byTerritory"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00091}00091\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ field\ ==\ \textcolor{stringliteral}{"{}track\_title"{}}:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00092}00092\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}track\_title"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00093}00093\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byTrack"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00094}00094\ \ \ \ \ \textcolor{keywordflow}{return}\ snapshot}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00095}00095\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00096}00096\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00097}\mbox{\hyperlink{namespace_report_snapshot_a402838bb70b79753510e72c4a34fc154}{00097}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespace_report_snapshot_a402838bb70b79753510e72c4a34fc154}{upload\_mongo}}(event,\ final\_path,\ snapshot,\ period):}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00098}00098\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Creates\ and\ updates\ snapshot\ to\ mongoDB.}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00099}00099\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00100}00100\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00101}00101\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ event\ (dict):\ contains\ the\ file\ and\ client\ info}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00102}00102\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ final\_path\ (str):\ Path\ where\ original\ csv\ is\ saved\ in\ s3}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00103}00103\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ snapshot\ (dict):\ it\ contains\ all\ fields\ info}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00104}00104\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ period\ (str):\ month\ and\ year\ when\ sales\ were\ processed}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00105}00105\ \textcolor{stringliteral}{\ \ \ \ Returns:\ Nothing}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00106}00106\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00107}00107\ \ \ \ \ name\ =\ final\_path.split(\textcolor{stringliteral}{"{}/"{}})[-\/1]}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00108}00108\ \ \ \ \ file\_id\ =\ \textcolor{stringliteral}{"{}\{\}\_report\_\{\}"{}}.format(event[\textcolor{stringliteral}{"{}client\_id"{}}],\ event[\textcolor{stringliteral}{"{}date"{}}])}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00109}00109\ \ \ \ \ document\ =\ \{}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00110}00110\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}file\_db\_id"{}}:\ file\_id,}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00111}00111\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}finished"{}},}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00112}00112\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}client\_id"{}}:\ event[\textcolor{stringliteral}{"{}client\_id"{}}],}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00113}00113\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}name"{}}:\ name,}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00114}00114\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}s3\_path"{}}:\ final\_path,}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00115}00115\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}reporting\_period"{}}:\ period,}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00116}00116\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}total\_local"{}}:\ total\_local,}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00117}00117\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}snapshot"{}}:\ snapshot,}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00118}00118\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}updated\_at"{}}:\ update\_at,\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00119}00119\ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}total\_rows"{}}:\ total\_rows}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00120}00120\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00121}00121\ \ \ \ \ c\ =\ snap\_collection.replace\_one(\{\textcolor{stringliteral}{"{}file\_db\_id"{}}:file\_id\},\ document)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00122}00122\ \ \ \ \ \textcolor{keywordflow}{if}\ c.matched\_count\ ==\ 0:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00123}00123\ \ \ \ \ \ \ \ \ snap\_collection.insert\_one(document)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00124}00124\ \ \ \ \ print(f\textcolor{stringliteral}{"{}Generating\ Snapshot\ with\ id:\ \{file\_id\}"{}})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00125}00125\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00126}\mbox{\hyperlink{namespace_report_snapshot_ab4de627686be8f3a33a079e7e7e60520}{00126}}\ \textcolor{keyword}{def\ }create\_snapshot(event,\ final\_path):}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00127}00127\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Executes\ full\ procedure}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00128}00128\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00129}00129\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00130}00130\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ event\ (dict):\ contains\ the\ file\ and\ client\ info}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00131}00131\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ final\_path\ (str):\ Path\ where\ original\ csv\ is\ saved\ in\ s3}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00132}00132\ \textcolor{stringliteral}{\ \ \ \ Returns:\ Nothing}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00133}00133\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00134}00134\ \ \ \ \ s3\_path\ =\ \textcolor{stringliteral}{"{}s3://\{\}/\{\}"{}}.format(event[\textcolor{stringliteral}{"{}bucket"{}}],\ final\_path)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00135}00135\ \ \ \ \ df\ =\ \mbox{\hyperlink{namespace_report_snapshot_a4038a78dd7952cb6dfbbdfa6beb24fca}{read\_report\_csv}}(s3\_path,\ 1\_000\_000)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00136}00136\ \ \ \ \ fields\ =\ [\textcolor{stringliteral}{"{}release\_id"{}},\ \textcolor{stringliteral}{"{}service\_id"{}},\ \textcolor{stringliteral}{"{}territory\_code"{}},\ \textcolor{stringliteral}{"{}artists"{}},\ \textcolor{stringliteral}{"{}track\_title"{}}]}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00137}00137\ \ \ \ \ snapshot\ =\ dict(\{\textcolor{stringliteral}{"{}byUPC"{}}:[],\ \textcolor{stringliteral}{"{}byArtist"{}}:[],\ \textcolor{stringliteral}{"{}byDSP"{}}:\ [],\ \textcolor{stringliteral}{"{}byTerritory"{}}:[],\ \textcolor{stringliteral}{"{}byTrack"{}}:[]\})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00138}00138\ \ \ \ \ snapshot\ =\ \mbox{\hyperlink{namespace_report_snapshot_a0a15f5df30b9169ee9e6c75baf35dc38}{group\_by\_field}}(df,\ fields,\ snapshot)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00139}00139\ \ \ \ \ period\ =\ df[\textcolor{stringliteral}{"{}date"{}}].value\_counts().index[0]}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00140}00140\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00141}00141\ \ \ \ \ \textcolor{keywordflow}{if}\ len(period)\ >\ 7:\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00142}00142\ \ \ \ \ \ \ \ \ period\ =\ period[:7].replace(\textcolor{stringliteral}{"{}-\/"{}},\textcolor{stringliteral}{"{}"{}})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00143}00143\ \ \ \ \ \textcolor{comment}{\#\ elif\ len(period)\ ==\ 7:}}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00144}00144\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00145}00145\ \ \ \ \ \ \ \ \ period\ =\ period.replace(\textcolor{stringliteral}{"{}-\/"{}},\textcolor{stringliteral}{"{}"{}})}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00146}00146\ }
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00147}00147\ \ \ \ \ print(\textcolor{stringliteral}{"{}EL\ PERIODO\ ES:\ "{}},\ period)}
\DoxyCodeLine{\Hypertarget{_report_snapshot_8py_source_l00148}00148\ \ \ \ \ \mbox{\hyperlink{namespace_report_snapshot_a402838bb70b79753510e72c4a34fc154}{upload\_mongo}}(event,\ final\_path,\ snapshot,\ period)}

\end{DoxyCode}
