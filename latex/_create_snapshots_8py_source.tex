\doxysection{Create\+Snapshots.\+py}
\hypertarget{_create_snapshots_8py_source}{}\label{_create_snapshots_8py_source}\index{/Users/michellmonroy/Documents/dev-\/glider/glider/src/importer/CreateSnapshots.py@{/Users/michellmonroy/Documents/dev-\/glider/glider/src/importer/CreateSnapshots.py}}
\mbox{\hyperlink{_create_snapshots_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00001}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots}{00001}}\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00002}00002\ \textcolor{keyword}{import}\ ssl}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00003}00003\ \textcolor{keyword}{import}\ boto3}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00004}00004\ \textcolor{keyword}{import}\ sys}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00005}00005\ \textcolor{keyword}{import}\ traceback}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00006}00006\ \textcolor{keyword}{import}\ awswrangler\ \textcolor{keyword}{as}\ wr}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00007}00007\ \textcolor{keyword}{from}\ datetime\ \textcolor{keyword}{import}\ datetime\ \textcolor{keyword}{as}\ dt}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00008}00008\ \textcolor{keyword}{from}\ dotenv\ \textcolor{keyword}{import}\ load\_dotenv}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00009}00009\ \textcolor{keyword}{from}\ pathlib\ \textcolor{keyword}{import}\ Path}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00010}00010\ \textcolor{keyword}{from}\ pymongo\ \textcolor{keyword}{import}\ MongoClient}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00011}00011\ \textcolor{keyword}{from}\ ErrorHandler\ \textcolor{keyword}{import}\ *}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00012}00012\ \textcolor{keyword}{from}\ TemplateManager\ \textcolor{keyword}{import}\ TemplateManager}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00013}00013\ \textcolor{keyword}{from}\ MongoConnection\ \textcolor{keyword}{import}\ mongo\_connection}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00014}00014\ \textcolor{comment}{\#\ from\ CreateSnapshotsFonal\ import\ snapshot\_playground}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00016}00016\ \textcolor{comment}{\#\ dotenv\_path\ =\ Path("{}src/importer/.env"{})}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00017}00017\ load\_dotenv()}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00018}00018\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00019}00019\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00020}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a5ecc0c11bb15661c60ec760f22e6854d}{00020}}\ mongo\_conn\ =\ \mbox{\hyperlink{classimporter_1_1_mongo_connection_1_1mongo__connection}{mongo\_connection}}()}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00021}00021\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00022}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a00acb278f979b26d00e299a3cee07cad}{00022}}\ collection\ =\ mongo\_conn.mongo\_conn\_snapshots()}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00023}00023\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00024}00024\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00025}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_afe3f23932326ea8bdfe8c5e5f5f535a4}{00025}}\ ACCESS\_ID,\ ACCESS\_KEY\ =\ os.environ.get(\textcolor{stringliteral}{"{}AWS\_KEY\_ID"{}}),\ os.environ.get(\textcolor{stringliteral}{"{}AWS\_KEY\_SECRET"{}})}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00026}00026\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00027}00027\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00028}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_ae5850639a2be42e542f26e5ca43165a0}{00028}}\ s3\_session\ =\ boto3.Session(aws\_access\_key\_id=ACCESS\_ID,\ aws\_secret\_access\_key=ACCESS\_KEY)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00030}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a7914ca118e4fd4de28fcde5343b3a575}{00030}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a7914ca118e4fd4de28fcde5343b3a575}{get\_data}}(file,\ bucket\_out,\ path\_out):}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00031}00031\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Receives\ a\ S3\ path\ and\ loads\ the\ data\ using\ awswrangler\ }}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00032}00032\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00033}00033\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00034}00034\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ file\ (str):\ current\ filename}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00035}00035\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ bucket\_out\ (str):\ bucket\ where\ parquet\ file\ is\ storage}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00036}00036\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ path\_out\ (str):\ s3\ path\ where\ parquet\ file\ is\ storage}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00037}00037\ \textcolor{stringliteral}{\ \ \ \ Returns:\ df\ (pandas\ dataframe)}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00038}00038\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00039}00039\ \ \ \ \ s3\_filename\ =\ \textcolor{stringliteral}{"{}s3://\{bucket\}/\{path\}/\{file\}"{}}.format(bucket=bucket\_out,path=path\_out,file=file)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00040}00040\ \ \ \ \ df\ =\ wr.s3.read\_parquet(s3\_filename,\ boto3\_session=s3\_session)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00041}00041\ \ \ \ \ \textcolor{keywordflow}{return}\ df}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00042}00042\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00043}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a56f0db3e03f459fc489bfc65e34fae47}{00043}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a56f0db3e03f459fc489bfc65e34fae47}{group\_by\_field}}(data,\ fields,\ snapshot):}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00044}00044\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Group\ by\ service\_id,\ territory\_code,\ artists\ and\ tracks}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00045}00045\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00046}00046\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00047}00047\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ data\ (pandas\ dataframe):\ current\ parquet\ file\ loaded\ as\ dataframe}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00048}00048\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ fields\ (list):\ list\ of\ fields\ that\ are\ considered\ to\ snapshot}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00049}00049\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ snapshot\ (dict):\ it\ will\ contain\ all\ fields\ info}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00050}00050\ \textcolor{stringliteral}{\ \ \ \ Returns:\ snap\ (dict)}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00051}00051\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00052}00052\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00053}00053\ \ \ \ \ \textcolor{keywordflow}{for}\ field\ \textcolor{keywordflow}{in}\ fields:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00054}00054\ \ \ \ \ \ \ \ \ df\_grouped\ =\ data.groupby(field)[\textcolor{stringliteral}{"{}total\_local"{}}].sum()}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00055}00055\ \ \ \ \ \ \ \ \ snap\ =\ \mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a708f3c910c8c8ce8d7656985fd96b8c6}{build\_snapshot}}(df\_grouped,\ field,\ snapshot)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00056}00056\ \ \ \ \ \textcolor{keywordflow}{return}\ snap}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00057}00057\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00058}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a708f3c910c8c8ce8d7656985fd96b8c6}{00058}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a708f3c910c8c8ce8d7656985fd96b8c6}{build\_snapshot}}(df,\ field,\ snapshot):}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00059}00059\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Checks\ the\ field\ and\ fill\ the\ snapshot\ field\ using\ grouped\ data.}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00060}00060\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00061}00061\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00062}00062\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ data\ (pandas\ dataframe):\ current\ parquet\ file\ loaded\ as\ dataframe}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00063}00063\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ field\ (str):\ current\ file\ used\ as\ filter}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00064}00064\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ snapshot\ (dict):\ it\ will\ contain\ all\ fields\ info}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00065}00065\ \textcolor{stringliteral}{\ \ \ \ Returns:\ snapshot\ (dict)}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00066}00066\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00067}00067\ \ \ \ \ \textcolor{keywordflow}{for}\ i\ \textcolor{keywordflow}{in}\ df.index:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00068}00068\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ field\ ==\ \textcolor{stringliteral}{"{}artists"{}}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00069}00069\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}artist"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00070}00070\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byArtist"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00071}00071\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ field\ ==\ \textcolor{stringliteral}{"{}service\_id"{}}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00072}00072\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}service"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00073}00073\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byDSP"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00074}00074\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ field\ ==\ \textcolor{stringliteral}{"{}territory\_code"{}}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00075}00075\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}territory\_code"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00076}00076\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byTerritory"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00077}00077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{elif}\ field\ ==\ \textcolor{stringliteral}{"{}track\_title"{}}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00078}00078\ \ \ \ \ \ \ \ \ \ \ \ \ element\ =\ \{\textcolor{stringliteral}{"{}track\_title"{}}:i,\ \textcolor{stringliteral}{"{}total"{}}:float(df.loc[i])\}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00079}00079\ \ \ \ \ \ \ \ \ \ \ \ \ snapshot[\textcolor{stringliteral}{"{}byTrack"{}}].append(element)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00080}00080\ \ \ \ \ \textcolor{keywordflow}{return}\ snapshot}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00081}00081\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00082}00082\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00083}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a071e9ae52b38709ce3c8bd02a9bd9c29}{00083}}\ \textcolor{keyword}{def\ }\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a071e9ae52b38709ce3c8bd02a9bd9c29}{upload\_mongo}}(results,\ file\_db\_id,\ update,\ length):}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00084}00084\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Update\ fields\ using\ snapshot\ variable.}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00085}00085\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00086}00086\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00087}00087\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ results\ (dict):\ current\ parquet\ file\ loaded\ as\ dataframe}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00088}00088\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ file\_db\_id\ (str):\ list\ of\ fields\ that\ are\ considered\ to\ snapshot}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00089}00089\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ update\ (datetime\ stamp):\ the\ current\ datetime\ where\ snapshot\ is\ updated}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00090}00090\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ length\ (int):\ total\ rows}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00091}00091\ \textcolor{stringliteral}{\ \ \ \ Returns:\ Nothing}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00092}00092\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00093}00093\ \ \ \ \ \textcolor{keywordflow}{for}\ field\ \textcolor{keywordflow}{in}\ results:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00094}00094\ \ \ \ \ \ \ \ \ collection.update\_one(\{\textcolor{stringliteral}{"{}file\_db\_id"{}}:file\_db\_id\},\{\textcolor{stringliteral}{"{}\$set"{}}:\ \{field:\ results[field]\}\})}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00095}00095\ \ \ \ \ collection.update\_one(\{\textcolor{stringliteral}{"{}file\_db\_id"{}}:file\_db\_id\},\{\textcolor{stringliteral}{"{}\$set"{}}:\ \{\textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}ingested"{}},\ \textcolor{stringliteral}{"{}status\_cause"{}}:\ \textcolor{stringliteral}{"{}No\ Errors"{}},\ \textcolor{stringliteral}{"{}error\_message"{}}:\ \textcolor{stringliteral}{"{}No\ message"{}},\textcolor{stringliteral}{"{}updated\_at"{}}:\ update,\ \textcolor{stringliteral}{"{}total\_rows"{}}:\ length\}\})}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00096}00096\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00097}00097\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00098}\mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_aee5fb2ba3058cce272feb71ff79ffe1a}{00098}}\ \textcolor{keyword}{def\ }results\_grouped(event,\ context):}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00099}00099\ \ \ \ \ \textcolor{stringliteral}{"{}"{}"{}Executes\ full\ procedure}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00100}00100\ \textcolor{stringliteral}{}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00101}00101\ \textcolor{stringliteral}{\ \ \ \ Args:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00102}00102\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ event\ (dict):\ is\ a\ dictionary\ with\ all\ client\ and\ sales\ information}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00103}00103\ \textcolor{stringliteral}{\ \ \ \ \ \ \ \ context\ (none):\ it's\ required\ just\ for\ lambda\ execution}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00104}00104\ \textcolor{stringliteral}{\ \ \ \ Returns:\ (dict)}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00105}00105\ \textcolor{stringliteral}{\ \ \ \ "{}"{}"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00106}00106\ \ \ \ \ \textcolor{keywordflow}{if}\ event[\textcolor{stringliteral}{"{}status"{}}]\ !=\ \textcolor{stringliteral}{"{}OK"{}}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00107}00107\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}No\ snapshots\ generated\ due:\ "{}}+str(event[\textcolor{stringliteral}{"{}status"{}}])\}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00108}00108\ \ \ \ \ snapshot\_created\ =\ dict()}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00109}00109\ \ \ \ \ snapshot\_not\_created\ =\ dict()}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00110}00110\ \ \ \ \ status\ =\ \textcolor{stringliteral}{"{}Snapshots\ Created"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00111}00111\ \ \ \ \ \textcolor{comment}{\#\ playground\_formats\ =\ [event["{}format"{}][i]\ for\ i\ in\ event["{}format"{}]\ if\ "{}playground"{}\ in\ i]}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00112}00112\ \ \ \ \ \textcolor{comment}{\#\ if\ playground\_formats:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00113}00113\ \ \ \ \ \textcolor{comment}{\#\ \ \ \ \ snapshot\_playground(event,\ playground\_formats)\ }}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00114}00114\ \ \ \ \ \textcolor{keywordflow}{for}\ formats\ \textcolor{keywordflow}{in}\ event[\textcolor{stringliteral}{"{}format"{}}]:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00115}00115\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ if\ "{}playground"{}\ in\ formats:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00116}00116\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ \ \ \ \ continue}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00117}00117\ \ \ \ \ \ \ \ \ files\ =\ event[\textcolor{stringliteral}{"{}format"{}}][formats][\textcolor{stringliteral}{"{}files"{}}]}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00118}00118\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(files)\ ==\ 0:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00120}00120\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ file\ \textcolor{keywordflow}{in}\ files:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00121}00121\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00122}00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ file\_db\_id\ =\ file[\textcolor{stringliteral}{"{}file\_id"{}}]}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00123}00123\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ filename\ =\ file[\textcolor{stringliteral}{"{}file"{}}]}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00124}00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ filename\ =\ filename+\textcolor{stringliteral}{"{}.parquet"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00125}00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fields\ =\ [\textcolor{stringliteral}{"{}service\_id"{}},\ \textcolor{stringliteral}{"{}territory\_code"{}},\ \textcolor{stringliteral}{"{}artists"{}},\ \textcolor{stringliteral}{"{}track\_title"{}}]}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00126}00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ df\ =\ \mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a7914ca118e4fd4de28fcde5343b3a575}{get\_data}}(filename,\ event[\textcolor{stringliteral}{"{}results\_bucket"{}}],\ event[\textcolor{stringliteral}{"{}results\_path"{}}])}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00127}00127\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ total\_rows\ =\ df.shape}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00128}00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ snapshot\ =\ dict(\{\textcolor{stringliteral}{"{}byArtist"{}}:[],\ \textcolor{stringliteral}{"{}byDSP"{}}:\ [],\ \textcolor{stringliteral}{"{}byTerritory"{}}:[],\ \textcolor{stringliteral}{"{}byTrack"{}}:[]\})}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00129}00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ snapshot\ =\ \mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a56f0db3e03f459fc489bfc65e34fae47}{group\_by\_field}}(df,\ fields,\ snapshot)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00130}00130\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ period\ =\ str(df.loc[0,\textcolor{stringliteral}{"{}date"{}}])}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00131}00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00132}00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ len(period)\ >\ 7:\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00133}00133\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ period\ =\ period[:7].replace(\textcolor{stringliteral}{"{}-\/"{}},\textcolor{stringliteral}{"{}"{}})}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00134}00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ elif\ len(period)\ ==\ 7:}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00135}00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00136}00136\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ period\ =\ period.replace(\textcolor{stringliteral}{"{}-\/"{}},\textcolor{stringliteral}{"{}"{}})}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00138}00138\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results\ =\ \{}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}OK"{}},}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00140}00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}reporting\_period"{}}:\ period,\textcolor{comment}{\#.getType(filename,\ formats),}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00141}00141\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}total\_local"{}}:\ float(df[\textcolor{stringliteral}{"{}total\_local"{}}].sum()),}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00142}00142\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}total\_gross"{}}:\ float(df[\textcolor{stringliteral}{"{}total\_gross"{}}].sum()),}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00143}00143\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}total\_net"{}}:\ float(df[\textcolor{stringliteral}{"{}total\_net"{}}].sum()),}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00144}00144\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}snapshot"{}}:\ snapshot}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00147}00147\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ results\ =\ \{}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00148}00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}status"{}}:\ \textcolor{stringliteral}{"{}OK"{}},}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00149}00149\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}reporting\_period"{}}:\ period,\textcolor{comment}{\#.getType(filename,\ formats),}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00150}00150\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}total\_local"{}}:\ float(df[\textcolor{stringliteral}{"{}total\_local"{}}].sum()),}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00151}00151\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}snapshot"{}}:\ snapshot}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00152}00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00153}00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(\textcolor{stringliteral}{"{}\{\}:\ \{\}\ Generating\ Snapshot"{}}.format(file\_db\_id,\ filename))}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00154}00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ update\_at\ =\ \ dt.now().replace(hour=0,\ minute=0,\ second=0,\ microsecond=0)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ \textcolor{stringliteral}{"{}playground\_digital"{}}\ \textcolor{keywordflow}{in}\ formats:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ root\_db\_id\ =\ file\_db\_id.split(\textcolor{stringliteral}{"{}-\/"{}})[:-\/1]}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00157}00157\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ root\_db\_id\ =\ \textcolor{stringliteral}{"{}-\/"{}}.join(root\_db\_id)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00158}00158\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a071e9ae52b38709ce3c8bd02a9bd9c29}{upload\_mongo}}(results,\ root\_db\_id,\ update\_at,\ total\_rows[0])}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00159}00159\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{namespaceimporter_1_1_create_snapshots_a071e9ae52b38709ce3c8bd02a9bd9c29}{upload\_mongo}}(results,\ file\_db\_id,\ update\_at,\ total\_rows[0])}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00160}00160\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ snapshot\_created[file\_db\_id]\ =\ filename}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00161}00161\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00162}00162\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ file\_db\_id\ =\ file[\textcolor{stringliteral}{"{}file\_id"{}}]}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00163}00163\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ print(sys.exc\_info()[2])}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00164}00164\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ print(traceback.format\_exc())}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00165}00165\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ print(e)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00166}00166\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ m\ =\ \textcolor{stringliteral}{"{}\{\}\(\backslash\)n\{\}"{}}.format(sys.exc\_info()[2],\ traceback.format\_exc())}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00167}00167\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ eh\ \ =\ \mbox{\hyperlink{classimporter_1_1_error_handler_1_1_error_handler}{ErrorHandler}}()}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00168}00168\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ error\ =\ eh.handle(e,\ m,\ file\_db\_id)}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00169}00169\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ status\ =\ \textcolor{stringliteral}{"{}Some\ snapshots\ were\ not\ created"{}}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00170}00170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ snapshot\_not\_created[file\_db\_id]\ =\ \{\textcolor{stringliteral}{"{}file"{}}:\ file[\textcolor{stringliteral}{"{}file"{}}],\ \textcolor{stringliteral}{"{}error"{}}:\ error\}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00171}00171\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00172}00172\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ return\ \{"{}status"{}:error\}\ \ \ \ }}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00173}00173\ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00174}00174\ \ \ \ \ \textcolor{keywordflow}{return}\ \{\textcolor{stringliteral}{"{}status"{}}:status,\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00175}00175\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}results\_bucket"{}}:\ event[\textcolor{stringliteral}{"{}results\_bucket"{}}],\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00176}00176\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}results\_path"{}}:\ event[\textcolor{stringliteral}{"{}results\_path"{}}],\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00177}00177\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}client\_id"{}}:\ event[\textcolor{stringliteral}{"{}client\_id"{}}],}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00178}00178\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}snapshots\_created"{}}:\ snapshot\_created,\ }
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00179}00179\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}no\_snapshots"{}}:\ snapshot\_not\_created\}}
\DoxyCodeLine{\Hypertarget{_create_snapshots_8py_source_l00180}00180\ }

\end{DoxyCode}
