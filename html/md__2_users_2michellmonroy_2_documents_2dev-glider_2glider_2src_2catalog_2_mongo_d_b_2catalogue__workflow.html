<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Glider: Catalogue Modules Workflow</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Glider
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Catalogue Modules Workflow</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md29"></a> </p>
<h1><a class="anchor" id="autotoc_md30"></a>
Description</h1>
<p>This module is able to downloads any catalogue from AudioSalad and upload to MongoDB using AWS tools. Also the catalogue can be generated using the usage reports which were processed by importer module.</p>
<h1><a class="anchor" id="autotoc_md31"></a>
Catalogue Submodule</h1>
<p>This submodule needs these requirements:</p>
<ol type="1">
<li>AWS account to use SQS tool</li>
<li>AudioSalad account (user and password)</li>
<li>MongoDB</li>
</ol>
<p>The general performance is the following:</p>
<ol type="1">
<li>Connects with AudioSalad endpoint</li>
<li>Downloads release per release</li>
<li>Upload releases to SQS to process them posteriorly</li>
<li>Reviews modified date to determine if current release should be updating ot inserted</li>
<li>Inserts new catalogue/Updates the existing catalogue</li>
</ol>
<h3><a class="anchor" id="autotoc_md32"></a>
Workflow</h3>
<p><img src="https://drive.google.com/uc?id=1NP7gdWb_0VpHqElcBTr-OuF2G4hiOtlJ" alt="" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md33"></a>
How to create venv dev</h3>
<ol type="1">
<li><p class="startli">Create a new virtual env (if you have created this venv pass to step 4)</p>
<p class="startli"><code>python3 -m venv glider_dev</code></p>
</li>
<li><p class="startli">Activate venv <br  />
</p>
<p class="startli">It's important to keep "glider_dev" name</p>
<p class="startli"><code>source glider_dev/bin/activate</code></p>
</li>
<li><p class="startli">Install requirements (only in case that you haven't install requirements yet)</p>
<p class="startli"><code>pip install -r src/importer/requirements.txt</code></p>
</li>
<li><p class="startli">Activate env variables. You should create two .env files</p>
<p class="startli">In this case, the variables for any submodule are the same.</p>
<p class="startli">a) .env.dev for developing and testing</p>
<p class="startli">b) .env.prod for production</p>
<div class="fragment"><div class="line">ENVIRONMENT=&lt;Development/Production&gt;</div>
<div class="line">AWS_KEY_ID=&lt;YOUR_AWS_KEY_ID&gt;</div>
<div class="line">AWS_SECRET_KEY=&lt;YOUR_AWS_SECRET_KEY&gt;</div>
<div class="line">MONGO_GLIDER=&lt;MONGO_CONNECTION_LINK&gt;</div>
<div class="line">DB=&lt;YOUR_DB&gt;</div>
<div class="line">COLLECTION=&lt;YOUR_MONGO_COLLECTION&gt;</div>
<div class="line">CAT_COLLECTION=&lt;YOUR_MONGO_COLLECTION_FOR_CATALOGUE&gt;</div>
<div class="line">REGION=&lt;YOUR_AWS_REGION&gt;</div>
<div class="line">AS_COLLECTION=&lt;YOUR_MONGO_COLLECTION_FOR_AS_CATALOGUE&gt;</div>
<div class="line">INSTANCE_ID_LITE=&lt;EC2_TO_EXECUTE_LITE_PROCEDURE&gt;</div>
<div class="line">INSTANCE_ID_PRO=&lt;EC2_TO_EXECUTE_PRO_PROCEDURE&gt;</div>
</div><!-- fragment --></li>
<li><p class="startli">Save and run, remember that you can use either of them</p>
<p class="startli"><code>source deploy/dev_vars.sh</code> for developing env</p>
<p class="startli"><code>source deploy/prod_vars.sh</code> for production env</p>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md34"></a>
Testing</h2>
<h3><a class="anchor" id="autotoc_md35"></a>
Local Testing</h3>
<ol type="1">
<li><p class="startli">Activate venv and variables</p>
<p class="startli"><code>source glider_dev/bin/activate</code></p>
<p class="startli"><code>source deploy/dev_vars.sh</code> <br  />
</p>
</li>
<li>Make sure that you have access to AudioSalad API i.e. user and password</li>
<li>Set the parameter to use <div class="fragment"><div class="line">&quot;--c&quot;, &quot;--collection&quot;: Collection name to upload releases</div>
<div class="line">&quot;--u&quot;, &quot;--user&quot;: AudioSalad API user name</div>
<div class="line">&quot;--p&quot;, &quot;--password&quot;: AudioSalad API password</div>
<div class="line">&quot;--a&quot;, &quot;--action&quot;: Action to do: &#39;update&#39; for update and existing catalog or &#39;insert&#39; to insert a new catalog</div>
<div class="line">&quot;--s&quot;, &quot;--sqs&quot;: ARN for SQS to use</div>
</div><!-- fragment --></li>
<li>Open a terminal</li>
<li><p class="startli">Go to glider project</p>
<div class="fragment"><div class="line">cd glider</div>
</div><!-- fragment --></li>
<li>Run <a class="el" href="main_8py.html">main.py</a> script giving the parameters show previously <div class="fragment"><div class="line">python src/catalog/MongoDB/main.py --c=&lt;YOUR_MONGO_COLLECTION_FOR_AS_CATALOGUE&gt; --u=&lt;YOUR_AS_USER&gt; --p=&lt;YOUR_AS_PASSWORD&gt; --a=&lt;insert/update&gt; --s=&lt;YOUR_SQS_ARN&gt;</div>
</div><!-- fragment --></li>
</ol>
<h1><a class="anchor" id="autotoc_md36"></a>
Catalogue Generation Submodule</h1>
<p>The general performance is the following:</p>
<ol type="1">
<li>Takes the current sales (processed previously by importer) from MongoDB</li>
<li>Identifies the unique releases_id</li>
<li>Once it has the releases, it takes the isrc_id and the album/track information to fill the catalogue in json format</li>
<li>The information is uploaded to MongoDB</li>
</ol>
<h3><a class="anchor" id="autotoc_md37"></a>
Workflow</h3>
<p><img src="https://drive.google.com/uc?id=14Aipul8V3IjB9SCoyORM7OJeg-bvkUMb" alt="" class="inline"/></p>
<h3><a class="anchor" id="autotoc_md38"></a>
How to create venv dev</h3>
<p>This module requires the same setup as importer module</p>
<h2><a class="anchor" id="autotoc_md39"></a>
Testing</h2>
<p>This module is part of importer module, so if you want to test it, you have to do the same procedure as shown in the importer workflow</p>
<h3><a class="anchor" id="autotoc_md40"></a>
Local Testing</h3>
<ol type="1">
<li>Upload one or more valid file in AWS s3 bucket</li>
<li><p class="startli">Activate testing variables</p>
<p class="startli"><code>source deploy/dev_vars.sh</code></p>
</li>
<li><p class="startli">Into tests/ create a python script following this format: test_importer.py To activate catalogue generation make sure that you set "cat_gen" = "True".</p>
<div class="fragment"><div class="line">import os</div>
<div class="line">import sys</div>
<div class="line">import traceback</div>
<div class="line">sys.path.insert(1, &quot;src/importer&quot;)</div>
<div class="line">sys.path.insert(1, &quot;run&quot;)</div>
<div class="line">from ReceivePath import receive_path</div>
<div class="line">from IdentifyFormat import identify_format</div>
<div class="line">from ProcessFiles import process_files_parallel</div>
<div class="line">from CreateSnapshots import results_grouped</div>
<div class="line">from CatalogueGenerator import generate_catalogue</div>
<div class="line">from SendNotifications import send_importer_notification</div>
<div class="line">from RunEC2 import stop_ec2</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">test_data = {</div>
<div class="line">    &quot;module&quot;: &quot;importer&quot;,</div>
<div class="line">    &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">    &quot;cat_gen&quot;: &quot;True&quot;,</div>
<div class="line">    &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">    &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">    &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">    </div>
<div class="line">    &quot;currency&quot;: { #Currency can change</div>
<div class="line">        &quot;USD&quot;: 1,</div>
<div class="line">        &quot;EUR&quot;: 1,</div>
<div class="line">        &quot;GBP&quot;: 1</div>
<div class="line">    },</div>
<div class="line">    </div>
<div class="line">    &quot;files&quot;:[</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">    ],</div>
<div class="line">    &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    try: </div>
<div class="line">        identify_formats = identify_format(input_data)</div>
<div class="line">        print(&quot;Formats identified: &quot;,identify_formats)</div>
<div class="line">        files_processed = process_files_parallel(identify_formats)</div>
<div class="line">        print(&quot;Files Processed: &quot;,files_processed)</div>
<div class="line">        snapshots = results_grouped(files_processed, None)</div>
<div class="line">        print(&quot;Snapshots: &quot;,snapshots)</div>
<div class="line">        if files_processed[&quot;cat_gen&quot;] == &quot;True&quot;:</div>
<div class="line">            catalogue = generate_catalogue(snapshots, None)</div>
<div class="line">            print(&quot;Catalogue: &quot;, catalogue)</div>
<div class="line">        send_importer_notification(&quot;success&quot;, input_data[&quot;module&quot;], input_data[&quot;on_finish&quot;])</div>
<div class="line">        stop_ec2()</div>
<div class="line">    except Exception as e:</div>
<div class="line">        message = str(sys.exc_info()[2]) + str(traceback.format_exc())</div>
<div class="line">        send_importer_notification(&quot;fail&quot;, input_data[&quot;module&quot;], input_data[&quot;on_finish&quot;], message)</div>
</div><!-- fragment --></li>
<li><p class="startli">Run script</p>
<p class="startli"><code>python tests/test_importer.py</code></p>
</li>
</ol>
<h2><a class="anchor" id="autotoc_md41"></a>
AWS Testing</h2>
<p>This procedure is exactly the same as the importer, but here is the steps to follow:</p>
<ol type="1">
<li>Go to AWS -&gt; Step Functions</li>
<li>Select the step function (select_and_execute_module)</li>
<li><p class="startli">Click on Start execution</p>
<p class="startli">(Optional: set a testing name)</p>
</li>
<li><p class="startli">Set json object</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;module&quot;: &quot;importer&quot;,</div>
<div class="line">    &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">    &quot;cat_gen&quot;: &quot;True&quot;, </div>
<div class="line">    &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">    &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">    &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">    </div>
<div class="line">    &quot;currency&quot;: { </div>
<div class="line">        &quot;USD&quot;: 1,</div>
<div class="line">        &quot;EUR&quot;: 1,</div>
<div class="line">        &quot;GBP&quot;: 1</div>
<div class="line">    },</div>
<div class="line">    </div>
<div class="line">    &quot;files&quot;:[</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">        {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">    ],</div>
<div class="line">    &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li><p class="startli">Click on Start execution. If the execution is successfully, you can see it in EC2 instance</p>
<p class="startli">a) In glider-lite </p><div class="fragment"><div class="line">ssh -i Glider-Postgres.pem ubuntu@ec2-35-179-24-180.eu-west-2.compute.amazonaws.com</div>
</div><!-- fragment --><p> b) In glider-pro </p><div class="fragment"><div class="line">ssh -i Glider-Postgres.pem ubuntu@ec2-18-168-188-120.eu-west-2.compute.amazonaws.com</div>
</div><!-- fragment --> </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
