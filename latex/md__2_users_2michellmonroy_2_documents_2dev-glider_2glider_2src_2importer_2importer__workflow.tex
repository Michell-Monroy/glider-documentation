\chapter{Importer Workflow}
\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow}{}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow}\index{Importer Workflow@{Importer Workflow}}
\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md20}%
\Hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md20}%
 \hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md21}{}\doxysection{\texorpdfstring{Description}{Description}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md21}
Importer module is composed of these steps\+:


\begin{DoxyEnumerate}
\item Receive usage reports\+: This step takes two paths from s3 (input path and output path) and takes the files to process. This function must check if the input path is a valid path to continue the process
\item Identify formats\+: Once the file is validated, there is a function which is in charge of searching for its format in a collection called “formats” in Mongo\+DB. The search is carried out as follows\+:
\item Gets the header from each usage report
\item Searches into Mongo\+DB some format whose “header” field is the same as the usage report header.
\item When the format is identified, the format name is extracted.
\item Map columns\+: Once the format of each usage report is already known, it’s possible to extract the columns, and data type necessary to carry out the mapping. This process is carried out by format and not by file, that is, the format already specifies which columns to use, so these are extracted from the “otto\+Mapping” field of the json files.
\item Generate new data using mapped columns\+: Once the required columns and their respective values are known, Data\+Frames are created (one per file) in which the columns are constructed according to the "{}name"{} field of "{}mapping\+Template"{} field from format.\+json. When this step is completed, the new usage reports are saved in s3 as parquet and mongo\+DB.
\end{DoxyEnumerate}\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md22}{}\doxysection{\texorpdfstring{Workflow}{Workflow}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md22}
\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md23}{}\doxysection{\texorpdfstring{How to set env variables and venv}{How to set env variables and venv}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md23}
There are two kind of variables, to dev and local testing.\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md24}{}\doxysubsection{\texorpdfstring{How to create venv dev}{How to create venv dev}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md24}

\begin{DoxyEnumerate}
\item Create a new virtual env (if you have created this venv pass to step 4)

{\ttfamily python3 -\/m venv glider\+\_\+dev}

It\textquotesingle{}s important to keep "{}glider\+\_\+dev"{} name
\item Activate venv

{\ttfamily source glider\+\_\+dev/bin/activate}
\item Install requirements

{\ttfamily pip install -\/r src/importer/requirements.\+txt}
\item Activate env variables. You should create two .env files

a) .env.\+dev for developing and testing

b) .env.\+prod for production

Both files have the same format, just add your dev and prod credentials for each file. Here\textquotesingle{}s an example 
\begin{DoxyCode}{0}
\DoxyCodeLine{ENVIRONMENT=<Development/Production>}
\DoxyCodeLine{AWS\_KEY\_ID=<YOUR\_AWS\_KEY\_ID>}
\DoxyCodeLine{AWS\_SECRET\_KEY=<YOUR\_AWS\_SECRET\_KEY>}
\DoxyCodeLine{SENDER\_EMAIL="{}example@example.me"{}}
\DoxyCodeLine{SENDER\_PASSWORD=<YOUR\_SENDER\_PASSWORD>}
\DoxyCodeLine{MONGO\_GLIDER=<MONGO\_CONNECTION\_LINK>}
\DoxyCodeLine{DATABASE\_URL=POSTGRES\_DATABASE}
\DoxyCodeLine{DB=<YOUR\_DB>}
\DoxyCodeLine{COLLECTION=<YOUR\_MONGO\_COLLECTION>}
\DoxyCodeLine{TRENDS\_COLLECTION=<YOUR\_MONGO\_COLLECTION\_FOR\_TRENDS>}
\DoxyCodeLine{SNAPSHOTS\_DB=<YOUR\_MONGO\_DB\_FOR\_SNAPSHOTS>}
\DoxyCodeLine{FORMATS=<YOUR\_MONGO\_COLLECTION\_FOR\_FORMATS>}
\DoxyCodeLine{SNAPSHOTS=<YOUR\_MONGO\_COLLECTION\_FOR\_SNAPSHOTS>}
\DoxyCodeLine{CAT\_COLLECTION=<YOUR\_MONGO\_COLLECTION\_FOR\_CATALOGUE>}
\DoxyCodeLine{REGION=<YOUR\_AWS\_REGION>}
\DoxyCodeLine{AS\_COLLECTION=<YOUR\_MONGO\_COLLECTION\_FOR\_AS\_CATALOGUE>}
\DoxyCodeLine{LAMBDA\_FUNCTION=<LAMBDA\_FUNCTION\_TO\_GENERATE\_PRESIGNED\_LINK>}
\DoxyCodeLine{FTP\_ACCESS=<YOUR\_MONGO\_COLLECTION\_FOR\_FTP\_CREDENTIALS>}
\DoxyCodeLine{INSTANCE\_ID\_LITE=<EC2\_TO\_EXECUTE\_LITE\_PROCEDURE>}
\DoxyCodeLine{INSTANCE\_ID\_PRO=<EC2\_TO\_EXECUTE\_PRO\_PROCEDURE>}

\end{DoxyCode}

\item Save and run

{\ttfamily source deploy/dev\+\_\+vars.\+sh} for developing env {\ttfamily source deploy/prod\+\_\+vars.\+sh} for production env

It loads env vars to be used still you change them.
\end{DoxyEnumerate}\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md25}{}\doxysubsection{\texorpdfstring{How to create venv local testing}{How to create venv local testing}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md25}

\begin{DoxyEnumerate}
\item Create a new virtual env (if you have created this venv pass to step 4)

{\ttfamily python3 -\/m venv glider\+\_\+testing}
\item Activate venv

{\ttfamily source glider\+\_\+testing/bin/activate}
\item Install requirements

{\ttfamily pip install -\/r src/importer/requirements.\+txt}
\item Run

{\ttfamily source deploy/dev\+\_\+vars.\+sh}

This command activate glider\+\_\+testing env and loads the env variables in glider/.env file which is useful to deploy infrastructure
\end{DoxyEnumerate}\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md26}{}\doxysection{\texorpdfstring{Testing}{Testing}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md26}
\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md27}{}\doxysubsection{\texorpdfstring{Local Testing}{Local Testing}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md27}

\begin{DoxyEnumerate}
\item Upload one or more valid file in AWS s3 bucket
\item Activate testing variables

{\ttfamily source deploy/dev\+\_\+vars.\+sh}
\item Into tests/ create a python script following this format\+: test\+\_\+importer.\+py


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ os}
\DoxyCodeLine{import\ sys}
\DoxyCodeLine{import\ traceback}
\DoxyCodeLine{sys.path.insert(1,\ "{}src/importer"{})}
\DoxyCodeLine{sys.path.insert(1,\ "{}run"{})}
\DoxyCodeLine{from\ ReceivePath\ import\ receive\_path}
\DoxyCodeLine{from\ IdentifyFormat\ import\ identify\_format}
\DoxyCodeLine{from\ ProcessFiles\ import\ process\_files\_parallel}
\DoxyCodeLine{from\ CreateSnapshots\ import\ results\_grouped}
\DoxyCodeLine{from\ CatalogueGenerator\ import\ generate\_catalogue}
\DoxyCodeLine{from\ SendNotifications\ import\ send\_importer\_notification}
\DoxyCodeLine{from\ RunEC2\ import\ stop\_ec2}
\DoxyCodeLine{}
\DoxyCodeLine{}
\DoxyCodeLine{}
\DoxyCodeLine{test\_data\ =\ \{}
\DoxyCodeLine{\ \ \ \ "{}module"{}:\ "{}importer"{},}
\DoxyCodeLine{\ \ \ \ "{}tag"{}:\ <"{}test"{}/"{}prod"{}>,}
\DoxyCodeLine{\ \ \ \ "{}cat\_gen"{}:\ <"{}True"{}/"{}False"{}>,\ \#True\ for\ generate\ catalogue\ from\ sales,\ False\ for\ don't}
\DoxyCodeLine{\ \ \ \ "{}client\_id"{}:\ <<client\_id>>,\ }
\DoxyCodeLine{\ \ \ \ "{}bucket"{}:\ [<<aws\_bucket\_in>>,\ <<aws\_bucket\_out>>],\ }
\DoxyCodeLine{\ \ \ \ "{}path"{}:\ [<<aws\_path\_in>>,\ <<aws\_path\_out>>],}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{\ \ \ \ "{}currency"{}:\ \{\ \#Currency\ can\ change}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}USD"{}:\ 1,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}EUR"{}:\ 1,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}GBP"{}:\ 1}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{\ \ \ \ "{}files"{}:[}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{"{}file\_id"{}:\ <<file\_id\_1>>,\ "{}file"{}:\ <<file\_1>>\},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{"{}file\_id"{}:\ <<file\_id\_2>>,\ "{}file"{}:\ <<file\_2>>\}}
\DoxyCodeLine{\ \ \ \ ],}
\DoxyCodeLine{\ \ \ \ "{}on\_finish"{}:\ <<webhook.url>>}
\DoxyCodeLine{}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{}
\DoxyCodeLine{}
\DoxyCodeLine{if\ \_\_name\_\_\ ==\ "{}\_\_main\_\_"{}:}
\DoxyCodeLine{\ \ \ \ try:\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ identify\_formats\ =\ identify\_format(input\_data)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ print("{}Formats\ identified:\ "{},identify\_formats)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ files\_processed\ =\ process\_files\_parallel(identify\_formats)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ print("{}Files\ Processed:\ "{},files\_processed)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ snapshots\ =\ results\_grouped(files\_processed,\ None)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ print("{}Snapshots:\ "{},snapshots)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ if\ files\_processed["{}cat\_gen"{}]\ ==\ "{}True"{}:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ catalogue\ =\ generate\_catalogue(snapshots,\ None)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ print("{}Catalogue:\ "{},\ catalogue)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ send\_importer\_notification("{}success"{},\ input\_data["{}module"{}],\ input\_data["{}on\_finish"{}])}
\DoxyCodeLine{\ \ \ \ \ \ \ \ stop\_ec2()}
\DoxyCodeLine{\ \ \ \ except\ Exception\ as\ e:}
\DoxyCodeLine{\ \ \ \ \ \ \ \ message\ =\ str(sys.exc\_info()[2])\ +\ str(traceback.format\_exc())}
\DoxyCodeLine{\ \ \ \ \ \ \ \ send\_importer\_notification("{}fail"{},\ input\_data["{}module"{}],\ input\_data["{}on\_finish"{}],\ message)}

\end{DoxyCode}

\item Run script

{\ttfamily python tests/test\+\_\+importer.\+py}
\end{DoxyEnumerate}\hypertarget{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md28}{}\doxysubsection{\texorpdfstring{AWS Testing}{AWS Testing}}\label{md__2_users_2michellmonroy_2_documents_2dev-glider_2glider_2src_2importer_2importer__workflow_autotoc_md28}
When infrastructure is deployed in AWS\+:


\begin{DoxyEnumerate}
\item Go to AWS -\/\texorpdfstring{$>$}{>} Step Functions
\item Select the step function (select\+\_\+and\+\_\+execute\+\_\+module)
\item Click on Start execution

(Optional\+: set a testing name)
\item Set json object


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ "{}module"{}:\ "{}importer"{},}
\DoxyCodeLine{\ \ \ \ "{}tag"{}:\ <"{}test"{}/"{}prod"{}>,}
\DoxyCodeLine{\ \ \ \ "{}cat\_gen"{}:\ <"{}True"{}/"{}False"{}>,\ }
\DoxyCodeLine{\ \ \ \ "{}client\_id"{}:\ <<client\_id>>,\ }
\DoxyCodeLine{\ \ \ \ "{}bucket"{}:\ [<<aws\_bucket\_in>>,\ <<aws\_bucket\_out>>],\ }
\DoxyCodeLine{\ \ \ \ "{}path"{}:\ [<<aws\_path\_in>>,\ <<aws\_path\_out>>],}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{\ \ \ \ "{}currency"{}:\ \{\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}USD"{}:\ 1,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}EUR"{}:\ 1,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ "{}GBP"{}:\ 1}
\DoxyCodeLine{\ \ \ \ \},}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{\ \ \ \ "{}files"{}:[}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{"{}file\_id"{}:\ <<file\_id\_1>>,\ "{}file"{}:\ <<file\_1>>\},}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \{"{}file\_id"{}:\ <<file\_id\_2>>,\ "{}file"{}:\ <<file\_2>>\}}
\DoxyCodeLine{\ \ \ \ ],}
\DoxyCodeLine{\ \ \ \ "{}on\_finish"{}:\ <<webhook.url>>}
\DoxyCodeLine{}
\DoxyCodeLine{\}}

\end{DoxyCode}

\item Click on Start execution. If the execution is successfully, you can see it in EC2 instance

a) In glider-\/lite 
\begin{DoxyCode}{0}
\DoxyCodeLine{ssh\ -\/i\ Glider-\/Postgres.pem\ ubuntu@ec2-\/35-\/179-\/24-\/180.eu-\/west-\/2.compute.amazonaws.com}

\end{DoxyCode}
 b) In glider-\/pro 
\begin{DoxyCode}{0}
\DoxyCodeLine{ssh\ -\/i\ Glider-\/Postgres.pem\ ubuntu@ec2-\/18-\/168-\/188-\/120.eu-\/west-\/2.compute.amazonaws.com}

\end{DoxyCode}
 
\end{DoxyEnumerate}