<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Glider: Trends Workflow</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Glider
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Trends Workflow</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md64"></a></p>
<h1><a class="anchor" id="autotoc_md65"></a>
Description</h1>
<p>The main task of the trends module is to homogenize the input data, transforming it into a format that can be used by the system to make charts, it's similar to importer procedure, but it 's more focused on the data transformation and not on the data import for revenues.</p>
<p>To achieve this, the trends module is composed of these steps:</p>
<ol type="1">
<li>Receive trends reports: This step takes two paths from s3 (input path and output path) and takes the files to process. This function must check if the input path is a valid path to continue the process</li>
<li>Identify formats: Once the file is validated, there is a function which is in charge of searching for its format in a collection called "formats" in MongoDB. The search is carried out as follows:</li>
<li>Gets the header from each usage report</li>
<li>Searches into MongoDB some format whose "header" field is the same as the usage report header.</li>
<li>When the format is identified, the format name is extracted.</li>
<li>Map columns: Once the format of each usage report is already known, it’s possible to extract the columns, and data type necessary to carry out the mapping. <br  />
 This process is carried out by format and not by file, that is, the format already specifies which columns to use, so these are extracted from the "ottoMapping" field of the json files.</li>
<li>Generate new data using mapped columns: Once the required columns and their respective values are known, DataFrames are created (one per file) in which the columns are constructed according to the "name" field of "mappingTemplate" field from format.json. <br  />
 When this step is completed, the new usage reports are saved in s3 as parquet and mongoDB.</li>
</ol>
<h1><a class="anchor" id="autotoc_md66"></a>
Workflow</h1>
<p><img src="../images/Trends_Workflow.png" alt="" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md67"></a>
Input format</h1>
<p>The input for this module consists in a json object which detemines what is the file(s) to process and currencies to apply.</p>
<table style="border-collapse: collapse; border: 1px solid #ccc;">
<tr>
<td style="width: 15%; border: 1px solid #ccc;"><b>Field</b> </td><td style="width: 55%; border: 1px solid #ccc;"><b>Description</b> </td><td style="width: 30%; border: 1px solid #ccc;"><b>Example</b>  </td></tr>
<tr>
<td style="border: 1px solid #ccc;">module </td><td style="border: 1px solid #ccc;">This field determines which route will be called. In this case it must to be "trends" </td><td style="border: 1px solid #ccc;">"trends"  </td></tr>
<tr>
<td style="border: 1px solid #ccc;">tag </td><td style="border: 1px solid #ccc;">This field determines which env variables have to be loaded </td><td style="border: 1px solid #ccc;">"test", "testing", "prod"  </td></tr>
<tr>
<td style="border: 1px solid #ccc;">client_id </td><td style="border: 1px solid #ccc;">String which represents the id of each client </td><td style="border: 1px solid #ccc;">"client1"  </td></tr>
<tr>
<td style="border: 1px solid #ccc;">bucket </td><td style="border: 1px solid #ccc;">List of string which contains 2 elements: input bucket (where files have been uploaded) and output bucket (where results will be upload) these items must to exist in your AWS account </td><td style="border: 1px solid #ccc;">["bucket-input","bucket-output"]  </td></tr>
<tr>
<td style="border: 1px solid #ccc;">path </td><td style="border: 1px solid #ccc;">List of string which contains 2 elements: input path (where files have been uploaded) and output path (where results will be upload) these items must to exist in your AWS account </td><td style="border: 1px solid #ccc;">["path-input","path-output"]  </td></tr>
<tr>
<td style="border: 1px solid #ccc;">files </td><td style="border: 1px solid #ccc;"><p class="starttd">List of dictionaries. Each dictionary contains file_id and file fields. </p>
<p class="intertd"><b>file_id</b>: String which represents the id of each file. It must not be repeated. </p>
<p class="intertd"></p>
<p class="intertd"><b>file</b>: String which represents the filename of each file. Somethimes, the filename is used for some formats to identify data keys, e.g some formats which may not have a date in the data will have it in the filename and the importer will attempt to take the date from the filename. </p>
<p class="endtd"></p>
</td><td style="border: 1px solid #ccc;">[{"file_id": "file1", "file":"filename1.csv"}, {"file_id": "file2", "file":"filename2"}]  </td></tr>
<tr>
<td style="border: 1px solid #ccc;">on_finish </td><td style="border: 1px solid #ccc;">Webhook link to send final status </td><td style="border: 1px solid #ccc;"><a href="https://your_webhook.site/">https://your_webhook.site/</a>  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md68"></a>
Allowed extensions</h1>
<ul>
<li>CSV format <a href="https://www.reviversoft.com/en/file-extensions/csv">More info</a> <br  />
</li>
<li>TXT format: <a href="https://www.reviversoft.com/en/file-extensions/txt">More info</a></li>
<li>TSV format: <a href="https://www.reviversoft.com/en/file-extensions/tsv">More info</a></li>
<li>XLS format: <a href="https://www.reviversoft.com/en/file-extensions/xls">More info</a> <br  />
</li>
</ul>
<h1><a class="anchor" id="autotoc_md69"></a>
Local Example</h1>
<h2><a class="anchor" id="autotoc_md70"></a>
Example using python</h2>
<p>This module is very similar to importer, so the steps are the same</p>
<ol type="1">
<li>Upload one or more valid file in AWS s3 bucket. It could be manually or via upload module</li>
<li>Set testing variables</li>
<li><p class="startli">Run server locally a) If you are using flask, run</p>
<p class="startli"><code>python app.py</code></p>
<p class="startli">b) If you use Docker, run</p>
<p class="startli"><code>docker-compose -f local.yml up</code></p>
<p class="startli">It runs a local sever in 5000 port. If you go to <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> in your browser you would see the api interface</p>
</li>
<li><p class="startli">Into tests/ create a python script following this format: test_route_trends.py</p>
<div class="fragment"><div class="line">import os</div>
<div class="line">import sys</div>
<div class="line">import traceback</div>
<div class="line">import requests</div>
<div class="line"> </div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    input_data = {</div>
<div class="line">        &quot;module&quot;: &quot;trends&quot;,</div>
<div class="line">        &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">        &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">        &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">        &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">        &quot;files&quot;:[</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">        ],</div>
<div class="line">        &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line"> </div>
<div class="line">    }</div>
<div class="line">    response = requests.post(&#39;http://127.0.0.1:5000/trends&#39;, json=input_data)</div>
<div class="line">    print(response.json())</div>
</div><!-- fragment --></li>
<li><p class="startli">Run script</p>
<p class="startli"><code>python tests/test_route_trends.py</code></p>
<p class="startli">If everything is ok, it returns the following:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;message&#39;: &#39;Module procedure will start immediately&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;trends&#39;, </div>
<div class="line">    &#39;status&#39;: 200</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli">If a field is missing or it's wrong, it returns:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;error_in_field&#39;: [&#39;client_id&#39;], </div>
<div class="line">    &#39;error_message&#39;: &#39;Field required&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;trends&#39;, </div>
<div class="line">    &#39;status&#39;: 500</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md71"></a>
Example using CURL</h2>
<ol type="1">
<li>Upload one or more valid file in AWS s3 bucket. It could be manually or via upload module</li>
<li>Open a terminal</li>
<li>Set the input <div class="fragment"><div class="line">curl -X &#39;POST&#39; \</div>
<div class="line">&#39;http://127.0.0.1:5000/trends&#39; \</div>
<div class="line">-H &#39;accept: application/json&#39; \</div>
<div class="line">-H &#39;Content-Type: application/json&#39; \</div>
<div class="line">-d &#39;{</div>
<div class="line">        &quot;module&quot;: &quot;trends&quot;,</div>
<div class="line">        &quot;tag&quot;: &lt;&quot;test&quot;/&quot;prod&quot;&gt;,</div>
<div class="line">        &quot;client_id&quot;: &lt;&lt;client_id&gt;&gt;, </div>
<div class="line">        &quot;bucket&quot;: [&lt;&lt;aws_bucket_in&gt;&gt;, &lt;&lt;aws_bucket_out&gt;&gt;], </div>
<div class="line">        &quot;path&quot;: [&lt;&lt;aws_path_in&gt;&gt;, &lt;&lt;aws_path_out&gt;&gt;],</div>
<div class="line">        &quot;files&quot;:[</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_1&gt;&gt;, &quot;file&quot;: &lt;&lt;file_1&gt;&gt;},</div>
<div class="line">            {&quot;file_id&quot;: &lt;&lt;file_id_2&gt;&gt;, &quot;file&quot;: &lt;&lt;file_2&gt;&gt;}</div>
<div class="line">        ],</div>
<div class="line">        &quot;on_finish&quot;: &lt;&lt;webhook.url&gt;&gt;</div>
<div class="line"> </div>
<div class="line">    }&#39;</div>
</div><!-- fragment --></li>
<li><p class="startli">Put the input in your terminal and Enter</p>
<p class="startli">If everything is ok, it returns the following:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;message&#39;: &#39;Module procedure will start immediately&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;trends&#39;, </div>
<div class="line">    &#39;status&#39;: 200</div>
<div class="line">}</div>
</div><!-- fragment --><p class="startli">If a field is missing or it's wrong, it returns:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &#39;date&#39;: CURRENT_DATE, </div>
<div class="line">    &#39;error_in_field&#39;: [&#39;client_id&#39;], </div>
<div class="line">    &#39;error_message&#39;: &#39;Field required&#39;, </div>
<div class="line">    &#39;module&#39;: &#39;trends&#39;, </div>
<div class="line">    &#39;status&#39;: 500</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="autotoc_md72"></a>
Example using API in Browser</h2>
<ol type="1">
<li><p class="startli">Run server locally a) If you are using flask, run</p>
<p class="startli"><code>python app.py</code></p>
<p class="startli">b) If you use Docker, run</p>
<p class="startli"><code>docker-compose -f local.yml up</code></p>
</li>
<li>Go to <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a></li>
<li>Click on "Default" text and "trends" button <img src="../images/api-web.png" alt="" class="inline"/></li>
<li>Click on "Try it out" button <img src="../images/api-box-trends.png" alt="" class="inline"/></li>
<li>Add the input in the text box and click on "Execute" button</li>
</ol>
<h2><a class="anchor" id="autotoc_md73"></a>
AWS Routes</h2>
<p>When infrastructure is deployed in AWS (ECS, ECR):</p>
<p>Repeat all steps shown in previously, just change the link to server</p>
<p>a) For glider-staging </p><div class="fragment"><div class="line">http://glider-spot-staging-lb-999571427.us-east-1.elb.amazonaws.com/trends</div>
</div><!-- fragment --><p> b) For glider-production (unavailable) </p><div class="fragment"><div class="line">http://glider-production-lb-120036359.us-east-1.elb.amazonaws.com/trends</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md74"></a>
Troubleshooting</h1>
<h2><a class="anchor" id="autotoc_md75"></a>
Files not identified</h2>
<ol type="1">
<li><p class="startli">Go to webhook and check the status of procedure</p>
<p class="startli">If <code>status</code> is "fail" and <code>notification</code> includes "No format identified", means that the file header doesn’t match with any format in the database. So you have to add it.</p>
</li>
<li>Contact support to add a new format</li>
</ol>
<h2><a class="anchor" id="autotoc_md76"></a>
Files not processed</h2>
<p>Go to webhook and check the status of procedure and check the <code>notification</code> field</p>
<h3><a class="anchor" id="autotoc_md77"></a>
File could not be loaded</h3>
<p>This issue can be happened due an encoding error or a format change or code bug</p>
<p><b>Possible solution</b>: Contac to support</p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
